<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0066ff">
    <title>Zeiterfassung BR</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'br': {
                            50: '#e6f0ff',
                            100: '#cce0ff',
                            200: '#99c2ff',
                            300: '#66a3ff',
                            400: '#3385ff',
                            500: '#0066ff',
                            600: '#0052cc',
                            700: '#003d99',
                            800: '#002966',
                            900: '#001a4d',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    
    <style>
        @keyframes pulse-ring {
            0% { transform: scale(0.95); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(0.95); opacity: 1; }
        }
        .timer-active { animation: pulse-ring 1.5s ease-in-out infinite; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .modal-backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        body { -webkit-tap-highlight-color: transparent; }
        .sync-indicator { transition: all 0.3s; }
        .sync-indicator.syncing { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Modal visibility fix */
        .modal-show {
            display: flex !important;
        }
    </style>
</head>
<body class="bg-br-900 text-white min-h-screen">
    
    <!-- ==================== LOGIN SCREEN ==================== -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-br-800 rounded-2xl p-8 max-w-md w-full border border-br-600 text-center">
            <div class="text-6xl mb-4">üì∫</div>
            <h1 class="text-2xl font-bold mb-2">Zeiterfassung BR</h1>
            <p class="text-br-200 mb-6">Bayerischer Rundfunk Style</p>
            
            <!-- E-Mail/Passwort Login -->
            <div id="emailLoginForm" class="space-y-3 mb-6">
                <input type="email" id="loginEmail" placeholder="E-Mail-Adresse" 
                       class="w-full px-4 py-3 bg-br-700 border border-br-500 rounded-xl text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none">
                <input type="password" id="loginPassword" placeholder="Passwort" 
                       class="w-full px-4 py-3 bg-br-700 border border-br-500 rounded-xl text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none">
                <button onclick="signInWithEmail()" id="emailLoginBtn" class="w-full py-3 bg-br-500 hover:bg-br-400 rounded-xl font-medium transition-all">
                    üìß Mit E-Mail anmelden
                </button>
                <div class="flex gap-2">
                    <button onclick="showRegisterForm()" class="flex-1 py-2 bg-br-700 hover:bg-br-600 rounded-lg text-sm transition-all">
                        Neu registrieren
                    </button>
                    <button onclick="resetPassword()" class="flex-1 py-2 bg-br-700 hover:bg-br-600 rounded-lg text-sm transition-all">
                        Passwort vergessen
                    </button>
                </div>
            </div>
            
            <!-- Registrierungsformular (versteckt) -->
            <div id="registerForm" class="space-y-3 mb-6 hidden">
                <input type="email" id="registerEmail" placeholder="E-Mail-Adresse" 
                       class="w-full px-4 py-3 bg-br-700 border border-br-500 rounded-xl text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none">
                <input type="password" id="registerPassword" placeholder="Passwort (min. 6 Zeichen)" 
                       class="w-full px-4 py-3 bg-br-700 border border-br-500 rounded-xl text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none">
                <input type="password" id="registerPasswordConfirm" placeholder="Passwort best√§tigen" 
                       class="w-full px-4 py-3 bg-br-700 border border-br-500 rounded-xl text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none">
                <button onclick="registerWithEmail()" class="w-full py-3 bg-green-600 hover:bg-green-500 rounded-xl font-medium transition-all">
                    ‚úÖ Konto erstellen
                </button>
                <button onclick="showLoginForm()" class="w-full py-2 bg-br-700 hover:bg-br-600 rounded-lg text-sm transition-all">
                    ‚Üê Zur√ºck zum Login
                </button>
            </div>
            
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-br-500"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-4 bg-br-800 text-br-200">oder</span>
                </div>
            </div>
            
            <button onclick="signInWithGoogle()" id="loginBtn" class="w-full py-4 bg-white text-gray-800 rounded-xl font-medium flex items-center justify-center gap-3 hover:bg-gray-100 transition-all">
                <svg class="w-6 h-6" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Mit Google anmelden
            </button>
            
            <div class="mt-6 text-xs text-br-300">
                Deine Daten werden sicher in der Cloud gespeichert
            </div>
        </div>
    </div>

    <!-- ==================== MAIN APP ==================== -->
    <div id="app" class="max-w-2xl mx-auto pb-20 hidden">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-800 to-blue-600 p-4 sticky top-0 z-40 shadow-lg">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <span class="text-2xl">‚è±Ô∏è</span>
                    Zeiterfassung Pro
                </h1>
                <div class="flex items-center gap-2">
                    <div id="syncStatus" class="sync-indicator text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded-full">
                        ‚òÅÔ∏è Sync
                    </div>
                    <button onclick="showUserMenu()" id="userAvatar" class="w-8 h-8 rounded-full bg-br-700 overflow-hidden">
                        <img id="userPhoto" src="" alt="" class="w-full h-full object-cover">
                    </button>
                </div>
            </div>
        </header>

        <!-- User Menu Dropdown -->
        <div id="userMenu" class="hidden absolute right-4 top-16 bg-br-800 rounded-xl border border-br-600 shadow-xl z-50 w-64">
            <div class="p-4 border-b border-br-600">
                <div id="userName" class="font-medium"></div>
                <div id="userEmail" class="text-xs text-br-200"></div>
            </div>
            <div class="p-2">
                <button onclick="signOut()" class="w-full text-left px-4 py-2 hover:bg-br-700 rounded-lg text-sm text-red-400">
                    üö™ Abmelden
                </button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <nav class="flex bg-br-800 border-b border-br-600 sticky top-16 z-30 overflow-x-auto">
            <button onclick="showTab('timer')" id="tab-timer" class="flex-1 py-3 text-sm font-medium tab-active whitespace-nowrap px-2">‚è±Ô∏è Timer</button>
            <button onclick="showTab('tasks')" id="tab-tasks" class="flex-1 py-3 text-sm font-medium text-br-200 whitespace-nowrap px-2">‚úÖ Aufgaben</button>
            <button onclick="showTab('entries')" id="tab-entries" class="flex-1 py-3 text-sm font-medium text-br-200 whitespace-nowrap px-2">üìã Eintr√§ge</button>
            <button onclick="showTab('projects')" id="tab-projects" class="flex-1 py-3 text-sm font-medium text-br-200 whitespace-nowrap px-2">üìÅ Projekte</button>
            <button onclick="showTab('dashboard')" id="tab-dashboard" class="flex-1 py-3 text-sm font-medium text-br-200 whitespace-nowrap px-2">üìä Stats</button>
            <button onclick="showTab('export')" id="tab-export" class="flex-1 py-3 text-sm font-medium text-br-200 whitespace-nowrap px-2">üíæ Export</button>
        </nav>

        <!-- Timer Tab -->
        <div id="content-timer" class="p-4 space-y-4">
            <!-- Projekt & Ort Auswahl -->
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-br-200 mb-1 block">Projekt</label>
                    <select id="currentProject" class="w-full bg-br-800 border border-br-500 rounded-lg p-3 text-sm">
                        <option value="">-- Kein Projekt --</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-br-200 mb-1 block">Arbeitsort</label>
                    <div class="flex gap-2">
                        <button onclick="setLocation(true)" id="btn-ho" class="flex-1 py-3 rounded-lg text-sm font-medium bg-br-500">üè† HO</button>
                        <button onclick="setLocation(false)" id="btn-office" class="flex-1 py-3 rounded-lg text-sm font-medium bg-br-700">üè¢ B√ºro</button>
                    </div>
                </div>
            </div>

            <!-- T√§tigkeit -->
            <div>
                <label class="text-xs text-br-200 mb-1 block">T√§tigkeit (optional)</label>
                <input type="text" id="currentActivity" placeholder="z.B. Meeting, Dokumentation..." class="w-full bg-br-800 border border-br-500 rounded-lg p-3 text-sm">
            </div>

            <!-- Timer Display -->
            <div id="timerDisplay" class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-8 text-center border border-br-600">
                <div id="timerValue" class="text-6xl font-mono font-bold text-blue-400 mb-4">00:00:00</div>
                <div id="timerStatus" class="text-br-200 text-sm mb-4">Bereit zum Starten</div>
                <div class="flex gap-3 justify-center">
                    <button onclick="toggleTimer()" id="btnStartStop" class="px-8 py-4 bg-green-600 hover:bg-green-500 rounded-xl text-lg font-bold transition-all">
                        ‚ñ∂Ô∏è Start
                    </button>
                    <button onclick="resetTimer()" class="px-6 py-4 bg-br-700 hover:bg-br-600 rounded-xl text-lg transition-all">
                        üîÑ
                    </button>
                </div>
            </div>

            <!-- Countdown Option -->
            <div class="bg-br-800 rounded-xl p-4 border border-br-600">
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="useCountdown" class="w-5 h-5 rounded" onchange="toggleCountdownMode()">
                    <label for="useCountdown" class="text-sm">Countdown-Modus</label>
                    <input type="number" id="countdownMinutes" placeholder="Min" min="1" max="480" value="60" class="w-20 bg-br-700 border border-br-500 rounded p-2 text-sm ml-auto" disabled>
                </div>
                <div class="mt-3 pt-3 border-t border-br-600">
                    <button onclick="testAlarm()" class="w-full py-2 bg-orange-700 hover:bg-orange-600 rounded-lg text-sm font-medium">
                        üîî Sound testen
                    </button>
                </div>
                <div class="mt-2">
                    <button onclick="activateNotifications()" id="btnNotifyStatus" class="w-full py-2 bg-br-700 hover:bg-br-600 rounded-lg text-sm font-medium">
                        üîï Benachrichtigungen aktivieren
                    </button>
                </div>
                <p class="mt-2 text-xs text-br-300 text-center">
                    ‚òÅÔ∏è Cloud-Alarm sendet Push auch bei geschlossener App
                </p>
            </div>

            <!-- Manueller Eintrag -->
            <details class="bg-br-800 rounded-xl border border-br-600">
                <summary class="p-4 cursor-pointer text-sm font-medium">‚ûï Manueller Eintrag</summary>
                <div class="p-4 pt-0 space-y-3">
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="text-xs text-br-200">Datum</label>
                            <input type="date" id="manualDate" class="w-full bg-br-700 border border-br-500 rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-br-200">Start</label>
                            <input type="time" id="manualStart" class="w-full bg-br-700 border border-br-500 rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-br-200">Ende</label>
                            <input type="time" id="manualEnd" class="w-full bg-br-700 border border-br-500 rounded p-2 text-sm">
                        </div>
                    </div>
                    <button onclick="addManualEntry()" class="w-full py-3 bg-br-500 hover:bg-br-400 rounded-lg text-sm font-medium">
                        ‚úÖ Eintrag hinzuf√ºgen
                    </button>
                </div>
            </details>

            <!-- Heutige Eintr√§ge -->
            <div class="bg-br-800 rounded-xl border border-br-600">
                <div class="p-4 border-b border-br-600 flex justify-between items-center">
                    <h3 class="font-medium">üìÖ Heute</h3>
                    <span id="todayTotal" class="text-blue-400 font-mono">0.00 h</span>
                </div>
                <div id="todayEntries" class="max-h-64 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Aufgaben Tab -->
        <div id="content-tasks" class="p-4 space-y-4 hidden">
            <!-- Filter-Optionen -->
            <div class="bg-br-800 rounded-xl p-4 border border-br-600">
                <div class="flex flex-wrap gap-2 items-center">
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" id="hideCompleted" class="w-4 h-4 rounded" onchange="renderTasks()">
                        Erledigte ausblenden
                    </label>
                    <select id="filterTaskPriority" class="bg-br-700 border border-br-500 rounded-lg px-3 py-2 text-sm" onchange="renderTasks()">
                        <option value="">Alle Priorit√§ten</option>
                        <option value="hoch">üî¥ Hoch</option>
                        <option value="mittel">üü° Mittel</option>
                        <option value="niedrig">üü¢ Niedrig</option>
                    </select>
                    <select id="filterTaskStatus" class="bg-br-700 border border-br-500 rounded-lg px-3 py-2 text-sm" onchange="renderTasks()">
                        <option value="">Alle Status</option>
                        <option value="offen">Offen</option>
                        <option value="in bearbeitung">In Bearbeitung</option>
                        <option value="erledigt">Erledigt</option>
                    </select>
                </div>
            </div>

            <!-- Neue Aufgabe -->
            <details class="bg-br-800 rounded-xl border border-br-600">
                <summary class="p-4 cursor-pointer text-sm font-medium">‚ûï Neue Aufgabe</summary>
                <div class="p-4 pt-0 space-y-3">
                    <div>
                        <label class="text-xs text-br-200">Aufgabe *</label>
                        <input type="text" id="newTaskTitle" placeholder="Was muss erledigt werden?" class="w-full bg-br-700 border border-br-500 rounded-lg p-3 text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-br-200">F√§llig am</label>
                            <input type="date" id="newTaskDue" class="w-full bg-br-700 border border-br-500 rounded-lg p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-br-200">Priorit√§t</label>
                            <select id="newTaskPriority" class="w-full bg-br-700 border border-br-500 rounded-lg p-2 text-sm">
                                <option value="mittel">üü° Mittel</option>
                                <option value="hoch">üî¥ Hoch</option>
                                <option value="niedrig">üü¢ Niedrig</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-br-200">Notizen</label>
                        <textarea id="newTaskNotes" placeholder="Zus√§tzliche Informationen..." class="w-full bg-br-700 border border-br-500 rounded-lg p-2 text-sm h-20"></textarea>
                    </div>
                    <button onclick="addTask()" class="w-full py-3 bg-br-500 hover:bg-br-400 rounded-lg text-sm font-medium">
                        ‚úÖ Aufgabe hinzuf√ºgen
                    </button>
                </div>
            </details>

            <!-- √úberf√§llige Aufgaben -->
            <div id="overdueTasks" class="hidden">
                <div class="bg-red-900/30 rounded-xl border border-red-700">
                    <div class="p-3 border-b border-red-700 flex items-center gap-2">
                        <span class="text-red-400">‚ö†Ô∏è</span>
                        <h3 class="font-medium text-red-400">√úberf√§llig</h3>
                        <span id="overdueCount" class="ml-auto bg-red-600 text-white text-xs px-2 py-1 rounded-full">0</span>
                    </div>
                    <div id="overdueTasksList" class="divide-y divide-red-900"></div>
                </div>
            </div>

            <!-- Heute f√§llige Aufgaben -->
            <div id="todayTasks" class="hidden">
                <div class="bg-orange-900/30 rounded-xl border border-orange-700">
                    <div class="p-3 border-b border-orange-700 flex items-center gap-2">
                        <span class="text-orange-400">üìÖ</span>
                        <h3 class="font-medium text-orange-400">Heute f√§llig</h3>
                        <span id="todayTasksCount" class="ml-auto bg-orange-600 text-white text-xs px-2 py-1 rounded-full">0</span>
                    </div>
                    <div id="todayTasksList" class="divide-y divide-orange-900"></div>
                </div>
            </div>

            <!-- Kommende Aufgaben -->
            <div id="upcomingTasks">
                <div class="bg-br-800 rounded-xl border border-br-600">
                    <div class="p-3 border-b border-br-600 flex items-center gap-2">
                        <span class="text-blue-400">üìã</span>
                        <h3 class="font-medium">Kommende Aufgaben</h3>
                        <span id="upcomingCount" class="ml-auto bg-gray-600 text-white text-xs px-2 py-1 rounded-full">0</span>
                    </div>
                    <div id="upcomingTasksList" class="divide-y divide-gray-700"></div>
                    <div id="noTasksMessage" class="p-8 text-center text-br-300 hidden">
                        <div class="text-4xl mb-2">‚ú®</div>
                        <p>Keine Aufgaben vorhanden</p>
                    </div>
                </div>
            </div>

            <!-- Erledigte Aufgaben -->
            <div id="completedTasksSection" class="hidden">
                <details class="bg-br-800 rounded-xl border border-br-600">
                    <summary class="p-3 cursor-pointer flex items-center gap-2">
                        <span class="text-green-400">‚úÖ</span>
                        <h3 class="font-medium text-br-200">Erledigte Aufgaben</h3>
                        <span id="completedCount" class="ml-auto bg-green-600/50 text-green-300 text-xs px-2 py-1 rounded-full">0</span>
                    </summary>
                    <div id="completedTasksList" class="divide-y divide-gray-700"></div>
                </details>
            </div>
        </div>

        <!-- Eintr√§ge Tab -->
        <div id="content-entries" class="p-4 space-y-4 hidden">
            <div class="flex gap-2">
                <input type="date" id="filterDate" class="flex-1 bg-br-800 border border-br-500 rounded-lg p-3 text-sm" onchange="window.filterChanged=true; window.entriesCurrentPage=1; filterEntries()">
                <select id="filterProject" class="flex-1 bg-br-800 border border-br-500 rounded-lg p-3 text-sm" onchange="window.filterChanged=true; window.entriesCurrentPage=1; filterEntries()">
                    <option value="">Alle Projekte</option>
                </select>
                <button onclick="toggleSortOrder()" id="btnSortOrder" class="px-4 bg-br-700 hover:bg-br-600 rounded-lg text-xl" title="Sortierung √§ndern">
                    ‚¨áÔ∏è
                </button>
            </div>
            <div class="flex justify-between items-center">
                <div id="entriesStatsTop" class="text-sm text-br-200"></div>
                <select id="pageSizeTop" onchange="changeEntriesPageSize(this.value)" class="bg-br-700 border border-br-600 rounded px-2 py-1 text-sm">
                    <option value="50">50 pro Seite</option>
                    <option value="100">100 pro Seite</option>
                    <option value="200">200 pro Seite</option>
                    <option value="99999">Alle anzeigen</option>
                </select>
            </div>
            <div id="entriesList" class="space-y-2"></div>
            <div id="entriesStats" class="bg-br-800 rounded-xl p-4 text-center text-sm text-br-200"></div>
        </div>

        <!-- Projekte Tab -->
        <div id="content-projects" class="p-4 space-y-4 hidden">
            <div class="bg-br-800 rounded-xl p-4 border border-br-600">
                <h3 class="font-medium mb-3">‚ûï Neues Projekt</h3>
                <div class="flex gap-2">
                    <input type="text" id="newProjectName" placeholder="Projektname" class="flex-1 bg-br-700 border border-br-500 rounded-lg p-3 text-sm">
                    <input type="color" id="newProjectColor" value="#3B82F6" class="w-12 h-12 rounded-lg cursor-pointer">
                    <button onclick="addProject()" class="px-4 bg-green-600 hover:bg-green-500 rounded-lg">‚úÖ</button>
                </div>
            </div>
            <div id="projectsList" class="space-y-2"></div>
        </div>

        <!-- Dashboard Tab -->
        <div id="content-dashboard" class="p-4 space-y-4 hidden">
            <div class="flex gap-2 flex-wrap">
                <button onclick="setDashboardPeriod('week')" id="dash-week" class="px-4 py-2 bg-br-500 rounded-lg text-sm">Diese Woche</button>
                <button onclick="setDashboardPeriod('month')" id="dash-month" class="px-4 py-2 bg-br-700 rounded-lg text-sm">Dieser Monat</button>
                <button onclick="setDashboardPeriod('year')" id="dash-year" class="px-4 py-2 bg-br-700 rounded-lg text-sm">Dieses Jahr</button>
                <button onclick="setDashboardPeriod('all')" id="dash-all" class="px-4 py-2 bg-br-700 rounded-lg text-sm">Alles</button>
                <button onclick="setDashboardPeriod('custom')" id="dash-custom" class="px-4 py-2 bg-br-700 rounded-lg text-sm">üìÖ Zeitraum</button>
            </div>

            <div id="dashboardDateRange" class="hidden grid grid-cols-2 gap-3 bg-br-800 rounded-xl p-3 border border-br-600">
                <div>
                    <label class="text-xs text-br-200 mb-1 block">Von</label>
                    <input type="date" id="dashFrom" class="w-full bg-br-700 border border-br-500 rounded-lg p-2 text-sm" onchange="updateDashboard()">
                </div>
                <div>
                    <label class="text-xs text-br-200 mb-1 block">Bis</label>
                    <input type="date" id="dashTo" class="w-full bg-br-700 border border-br-500 rounded-lg p-2 text-sm" onchange="updateDashboard()">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-gradient-to-br from-blue-900 to-blue-800 rounded-xl p-4">
                    <div class="text-3xl font-bold" id="statTotalHours">0</div>
                    <div class="text-xs text-blue-300">Stunden gesamt</div>
                </div>
                <div class="bg-gradient-to-br from-green-900 to-green-800 rounded-xl p-4">
                    <div class="text-3xl font-bold" id="statAvgPerDay">0</div>
                    <div class="text-xs text-green-300">√ò Stunden/Tag</div>
                </div>
                <div class="bg-gradient-to-br from-purple-900 to-purple-800 rounded-xl p-4">
                    <div class="text-3xl font-bold" id="statWorkDays">0</div>
                    <div class="text-xs text-purple-300">Arbeitstage</div>
                </div>
                <div class="bg-gradient-to-br from-orange-900 to-orange-800 rounded-xl p-4">
                    <div class="text-3xl font-bold" id="statEntries">0</div>
                    <div class="text-xs text-orange-300">Eintr√§ge</div>
                </div>
            </div>

            <div class="bg-br-800 rounded-xl p-4 border border-br-600">
                <h3 class="font-medium mb-3">üè† Homeoffice vs. üè¢ B√ºro</h3>
                <div class="flex gap-4">
                    <div class="flex-1 text-center">
                        <div class="text-2xl font-bold text-blue-400" id="statHomeoffice">0%</div>
                        <div class="text-xs text-br-200">Homeoffice</div>
                    </div>
                    <div class="flex-1 text-center">
                        <div class="text-2xl font-bold text-orange-400" id="statOffice">0%</div>
                        <div class="text-xs text-br-200">B√ºro</div>
                    </div>
                </div>
                <div class="mt-3 h-4 bg-br-700 rounded-full overflow-hidden flex">
                    <div id="hoBar" class="bg-blue-500 transition-all" style="width: 50%"></div>
                    <div id="officeBar" class="bg-orange-500 transition-all" style="width: 50%"></div>
                </div>
            </div>

            <div class="bg-br-800 rounded-xl p-4 border border-br-600">
                <h3 class="font-medium mb-3">üìä Stunden nach Projekt</h3>
                <div id="projectStats" class="space-y-2"></div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="content-export" class="p-4 space-y-4 hidden">
            <div class="bg-br-800 rounded-xl p-4 border border-br-600 space-y-4">
                <h3 class="font-medium">üì§ Daten exportieren</h3>
                
                <div>
                    <label class="text-xs text-br-200 mb-1 block">Zeitraum</label>
                    <select id="exportPeriod" class="w-full bg-br-700 border border-br-500 rounded-lg p-3 text-sm" onchange="toggleCustomDates()">
                        <option value="today">Heute</option>
                        <option value="week">Diese Woche</option>
                        <option value="month">Dieser Monat</option>
                        <option value="year">Dieses Jahr</option>
                        <option value="all">Alle Eintr√§ge</option>
                        <option value="custom">üìÖ Benutzerdefiniert...</option>
                    </select>
                </div>

                <div id="customDateRange" class="grid grid-cols-2 gap-3 hidden">
                    <div>
                        <label class="text-xs text-br-200 mb-1 block">Von</label>
                        <input type="date" id="exportFrom" class="w-full bg-br-700 border border-br-500 rounded-lg p-3 text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-br-200 mb-1 block">Bis</label>
                        <input type="date" id="exportTo" class="w-full bg-br-700 border border-br-500 rounded-lg p-3 text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportXLSX()" class="py-3 bg-green-700 hover:bg-green-600 rounded-lg text-sm font-medium">üìä XLSX</button>
                    <button onclick="exportPDF()" class="py-3 bg-red-700 hover:bg-red-600 rounded-lg text-sm font-medium">üìÑ PDF</button>
                    <button onclick="exportCSV()" class="py-3 bg-br-600 hover:bg-br-500 rounded-lg text-sm font-medium">üìã CSV</button>
                    <button onclick="exportJSON()" class="py-3 bg-purple-700 hover:bg-purple-600 rounded-lg text-sm font-medium">üíæ JSON</button>
                </div>
            </div>

            <div class="bg-br-800 rounded-xl p-4 border border-br-600 space-y-4">
                <h3 class="font-medium">üì• Daten importieren</h3>
                <input type="file" id="importFile" accept=".json" class="w-full bg-br-700 border border-br-500 rounded-lg p-3 text-sm" onchange="importJSON()">
                <p class="text-xs text-br-300">JSON-Backup importieren (Daten werden hinzugef√ºgt)</p>
            </div>

            <div class="bg-br-800 rounded-xl p-4 border border-red-900 space-y-4">
                <h3 class="font-medium text-red-400">‚ö†Ô∏è Gefahrenzone</h3>
                <button onclick="clearAllData()" class="w-full py-3 bg-red-900 hover:bg-red-800 rounded-lg text-sm font-medium">üóëÔ∏è Alle Daten l√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">

    <!-- Aufgaben Startbildschirm Modal -->
    <div id="tasksDashboardModal" class="fixed inset-0 z-60 hidden items-center justify-center modal-backdrop">
        <div class="bg-br-800 rounded-2xl p-6 m-4 max-w-lg w-full border border-br-600 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span>üìã</span> Deine Aufgaben
                </h2>
                <button onclick="closeTasksDashboard()" class="text-br-200 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div id="dashboardTasksContent">
                <!-- √úberf√§llige Aufgaben -->
                <div id="dashOverdue" class="mb-4 hidden">
                    <div class="bg-red-900/40 rounded-xl border border-red-600 p-4">
                        <h3 class="text-red-400 font-medium mb-3 flex items-center gap-2">
                            <span>‚ö†Ô∏è</span> √úberf√§llig
                        </h3>
                        <div id="dashOverdueList" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- Heute f√§llige Aufgaben -->
                <div id="dashToday" class="mb-4 hidden">
                    <div class="bg-orange-900/40 rounded-xl border border-orange-600 p-4">
                        <h3 class="text-orange-400 font-medium mb-3 flex items-center gap-2">
                            <span>üìÖ</span> Heute f√§llig
                        </h3>
                        <div id="dashTodayList" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- Keine dringenden Aufgaben -->
                <div id="dashNoUrgent" class="text-center py-8 hidden">
                    <div class="text-5xl mb-3">‚ú®</div>
                    <p class="text-br-200">Keine √ºberf√§lligen oder heutigen Aufgaben!</p>
                    <p class="text-br-300 text-sm mt-2">Du bist auf dem Laufenden.</p>
                </div>
            </div>
            
            <div class="mt-6 flex gap-3">
                <button onclick="closeTasksDashboard()" class="flex-1 py-3 bg-br-700 hover:bg-br-600 rounded-lg text-sm font-medium">
                    Schlie√üen
                </button>
                <button onclick="closeTasksDashboard(); showTab('tasks');" class="flex-1 py-3 bg-br-500 hover:bg-br-400 rounded-lg text-sm font-medium">
                    Alle Aufgaben ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Original Edit Modal -->
        <div class="bg-br-800 rounded-2xl p-6 m-4 max-w-md w-full border border-br-600 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">‚úèÔ∏è Eintrag bearbeiten</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-br-200">Datum</label>
                    <input type="date" id="editDate" class="w-full bg-br-700 border border-br-500 rounded-lg p-3 text-sm">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-br-200">Start</label>
                        <input type="time" id="editStart" class="w-full bg-br-700 border border-br-500 rounded-lg p-3 text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-br-200">Ende</label>
                        <input type="time" id="editEnd" class="w-full bg-br-700 border border-br-500 rounded-lg p-3 text-sm">
                    </div>
                </div>
                <div>
                    <label class="text-xs text-br-200">Projekt</label>
                    <select id="editProject" class="w-full bg-br-700 border border-br-500 rounded-lg p-3 text-sm"></select>
                </div>
                <div>
                    <label class="text-xs text-br-200">T√§tigkeit</label>
                    <input type="text" id="editActivity" class="w-full bg-br-700 border border-br-500 rounded-lg p-3 text-sm">
                </div>
                <div>
                    <label class="text-xs text-br-200">Arbeitsort</label>
                    <select id="editLocation" class="w-full bg-br-700 border border-br-500 rounded-lg p-3 text-sm">
                        <option value="true">üè† Homeoffice</option>
                        <option value="false">üè¢ B√ºro</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditModal()" class="flex-1 py-3 bg-br-700 hover:bg-br-600 rounded-lg text-sm">Abbrechen</button>
                <button onclick="saveEdit()" class="flex-1 py-3 bg-br-500 hover:bg-br-400 rounded-lg text-sm font-medium">üíæ Speichern</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // FIREBASE CONFIGURATION - HIER DEINE DATEN EINTRAGEN!
        // ============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDJcK71mE0pjol-2loS9q9XhXFwxnJMu6U",
            authDomain: "appazeit.firebaseapp.com",
            projectId: "appazeit",
            storageBucket: "appazeit.firebasestorage.app",
            messagingSenderId: "977328058000",
            appId: "1:977328058000:web:360b79579689552423b215"
        };
        // ============================================================

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();
        
        // Firebase Messaging (f√ºr Push-Notifications)
        let messaging = null;
        let fcmToken = null;
        
        // Messaging nur initialisieren wenn unterst√ºtzt
        if ('Notification' in window && firebase.messaging.isSupported()) {
            messaging = firebase.messaging();
            
            // Foreground Messages empfangen
            messaging.onMessage((payload) => {
                console.log('üîî Foreground Message:', payload);
                // Zeige Notification auch wenn App aktiv ist
                playAlarmSound();
                showAlarmModal();
            });
        }
        
        // Offline-Persistenz aktivieren
        db.enablePersistence({ synchronizeTabs: true }).catch(err => {
            console.log('Offline-Persistenz nicht verf√ºgbar:', err.code);
        });

        // ==================== STATE ====================
        let entries = [];
        let projects = {};
        let tasks = [];  // Aufgaben-Array
        let timerInterval = null;
        let timerStart = null;
        let timerSeconds = 0;
        let isRunning = false;
        let isHomeoffice = true;
        let editingEntryId = null;
        let editingTaskId = null;  // F√ºr Task-Bearbeitung
        let dashboardPeriod = 'week';
        let currentUser = null;
        let unsubscribeEntries = null;
        let unsubscribeProjects = null;
        let unsubscribeTasks = null;  // F√ºr Tasks-Listener
        let sortOrderDescending = true; // true = neueste zuerst, false = √§lteste zuerst
        let tasksDashboardShown = false;  // Ob Startbildschirm schon gezeigt wurde
        
        // Audio Context f√ºr Alarm (muss durch User-Klick aktiviert werden)
        let audioCtx = null;
        
        function initAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            // iOS Safari: Context "entsperren" durch leisen Ton
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            // Stiller Ton um Audio zu aktivieren
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = 0.001; // Fast unh√∂rbar
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        // ==================== INITIAL PROJECTS ====================
        const INITIAL_PROJECTS = {
            'AFT': { name: 'AFT', color: '#3B82F6' },
            'Daily': { name: 'Daily', color: '#10B981' },
            'Dienstreise': { name: 'Dienstreise', color: '#F59E0B' },
            'GPR-Sitzung': { name: 'GPR-Sitzung', color: '#EF4444' },
            'Klausur': { name: 'Klausur', color: '#8B5CF6' },
            '√ñPR-Sitzung': { name: '√ñPR-Sitzung', color: '#EC4899' },
            'DS-ITS JourFixe': { name: 'DS-ITS JourFixe', color: '#06B6D4' },
            'JourFixe TuG': { name: 'JourFixe TuG', color: '#84CC16' },
            'PR! Nachgefragt': { name: 'PR! Nachgefragt', color: '#F97316' },
            'Personalversammlung': { name: 'Personalversammlung', color: '#A855F7' },
            'Sprechstunde FM': { name: 'Sprechstunde FM', color: '#14B8A6' }
        };
        
        // Hilfsfunktion: Projektname f√ºr Firebase-Key sanitizen
        function sanitizeProjectKey(name) {
            // Ersetze / durch - f√ºr Firebase-kompatible Keys
            return name.replace(/\//g, '-');
        }

        // ==================== AUTHENTICATION ====================
        
        // Auth State Observer
        auth.onAuthStateChanged(user => {
            console.log('Auth State:', user ? user.email : 'nicht angemeldet');
            if (user) {
                currentUser = user;
                showApp();
                setupRealtimeSync();
                restoreTimerState();
            } else {
                currentUser = null;
                showLogin();
                cleanupSync();
            }
        });

        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            
            // Immer Popup verwenden - funktioniert besser auf allen Plattformen
            try {
                document.getElementById('loginBtn').disabled = true;
                document.getElementById('loginBtn').innerHTML = '‚è≥ Anmelden...';
                
                await auth.signInWithPopup(provider);
                console.log('‚úÖ Login erfolgreich');
            } catch (err) {
                console.error('Login Error:', err.code, err.message);
                
                document.getElementById('loginBtn').disabled = false;
                document.getElementById('loginBtn').innerHTML = '<svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Mit Google anmelden';
                
                if (err.code === 'auth/popup-blocked') {
                    alert('‚ö†Ô∏è Popup wurde blockiert!\n\nBitte erlaube Popups f√ºr diese Seite:\n\n' +
                          'üì± iPhone/iPad:\n' +
                          '1. Einstellungen ‚Üí Safari\n' +
                          '2. "Popups blockieren" deaktivieren\n' +
                          '3. Seite neu laden und erneut versuchen');
                } else if (err.code === 'auth/popup-closed-by-user') {
                    // Benutzer hat Popup geschlossen - nichts tun
                } else if (err.code === 'auth/cancelled-popup-request') {
                    // Ignorieren
                } else if (err.code === 'auth/network-request-failed') {
                    alert('‚ùå Netzwerkfehler. Bitte Internetverbindung pr√ºfen.');
                } else {
                    alert('‚ùå Login fehlgeschlagen: ' + err.message);
                }
            }
        }

        function signOut() {
            auth.signOut();
            hideUserMenu();
        }

        // ==================== E-MAIL AUTHENTICATION ====================
        
        function showRegisterForm() {
            document.getElementById('emailLoginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }
        
        function showLoginForm() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('emailLoginForm').classList.remove('hidden');
        }
        
        async function signInWithEmail() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('Bitte E-Mail und Passwort eingeben.');
                return;
            }
            
            const btn = document.getElementById('emailLoginBtn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Anmelden...';
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ E-Mail Login erfolgreich');
            } catch (err) {
                console.error('E-Mail Login Error:', err.code, err.message);
                
                btn.disabled = false;
                btn.innerHTML = 'üìß Mit E-Mail anmelden';
                
                switch (err.code) {
                    case 'auth/user-not-found':
                        alert('‚ùå Kein Konto mit dieser E-Mail gefunden.\n\nM√∂chtest du dich registrieren?');
                        break;
                    case 'auth/wrong-password':
                        alert('‚ùå Falsches Passwort.');
                        break;
                    case 'auth/invalid-email':
                        alert('‚ùå Ung√ºltige E-Mail-Adresse.');
                        break;
                    case 'auth/too-many-requests':
                        alert('‚ö†Ô∏è Zu viele Versuche. Bitte warte einen Moment.');
                        break;
                    default:
                        alert('‚ùå Login fehlgeschlagen: ' + err.message);
                }
            }
        }
        
        async function registerWithEmail() {
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            
            if (!email || !password) {
                alert('Bitte E-Mail und Passwort eingeben.');
                return;
            }
            
            if (password.length < 6) {
                alert('Das Passwort muss mindestens 6 Zeichen haben.');
                return;
            }
            
            if (password !== passwordConfirm) {
                alert('Die Passw√∂rter stimmen nicht √ºberein.');
                return;
            }
            
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                console.log('‚úÖ Registrierung erfolgreich');
                showToast('‚úÖ Konto erstellt! Du bist jetzt angemeldet.');
            } catch (err) {
                console.error('Registrierung Error:', err.code, err.message);
                
                switch (err.code) {
                    case 'auth/email-already-in-use':
                        alert('‚ùå Diese E-Mail ist bereits registriert.\n\nBitte melde dich an oder nutze "Passwort vergessen".');
                        break;
                    case 'auth/invalid-email':
                        alert('‚ùå Ung√ºltige E-Mail-Adresse.');
                        break;
                    case 'auth/weak-password':
                        alert('‚ùå Passwort zu schwach. Mindestens 6 Zeichen.');
                        break;
                    default:
                        alert('‚ùå Registrierung fehlgeschlagen: ' + err.message);
                }
            }
        }
        
        async function resetPassword() {
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!email) {
                alert('Bitte gib zuerst deine E-Mail-Adresse ein.');
                return;
            }
            
            try {
                await auth.sendPasswordResetEmail(email);
                alert('‚úÖ Passwort-Reset E-Mail gesendet!\n\nBitte pr√ºfe dein Postfach (auch Spam-Ordner).');
            } catch (err) {
                console.error('Password Reset Error:', err.code, err.message);
                
                switch (err.code) {
                    case 'auth/user-not-found':
                        alert('‚ùå Kein Konto mit dieser E-Mail gefunden.');
                        break;
                    case 'auth/invalid-email':
                        alert('‚ùå Ung√ºltige E-Mail-Adresse.');
                        break;
                    default:
                        alert('‚ùå Fehler: ' + err.message);
                }
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            // Reset forms
            showLoginForm();
        }

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // User Info anzeigen
            const userPhoto = document.getElementById('userPhoto');
            if (currentUser.photoURL) {
                userPhoto.src = currentUser.photoURL;
                userPhoto.style.display = 'block';
            } else {
                // Fallback: Zeige Initialen oder Emoji
                userPhoto.src = '';
                userPhoto.style.display = 'none';
                document.getElementById('userAvatar').innerHTML = 'üë§';
            }
            
            // Name: displayName oder E-Mail-Prefix
            const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'User';
            document.getElementById('userName').textContent = displayName;
            document.getElementById('userEmail').textContent = currentUser.email || '';
            
            initUI();
        }

        function showUserMenu() {
            document.getElementById('userMenu').classList.toggle('hidden');
        }

        function hideUserMenu() {
            document.getElementById('userMenu').classList.add('hidden');
        }

        // Click outside to close menu
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#userAvatar') && !e.target.closest('#userMenu')) {
                hideUserMenu();
            }
        });

        // ==================== FIRESTORE SYNC ====================
        function setupRealtimeSync() {
            if (!currentUser) return;
            
            setSyncStatus('syncing');
            
            // Entries listener
            unsubscribeEntries = db.collection('users').doc(currentUser.uid)
                .collection('entries')
                .orderBy('datum', 'desc')
                .onSnapshot(snapshot => {
                    entries = [];
                    snapshot.forEach(doc => {
                        entries.push({ id: doc.id, ...doc.data() });
                    });
                    updateTodayView();
                    if (document.getElementById('content-entries').classList.contains('hidden') === false) {
                        filterEntries();
                    }
                    if (document.getElementById('content-dashboard').classList.contains('hidden') === false) {
                        updateDashboard();
                    }
                    setSyncStatus('synced');
                }, err => {
                    console.error('Entries sync error:', err);
                    setSyncStatus('error');
                });
            
            // Projects listener
            unsubscribeProjects = db.collection('users').doc(currentUser.uid)
                .collection('projects')
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        // Initialize with default projects
                        initializeProjects();
                    } else {
                        projects = {};
                        snapshot.forEach(doc => {
                            projects[doc.id] = doc.data();
                        });
                        updateProjectSelects();
                        if (document.getElementById('content-projects').classList.contains('hidden') === false) {
                            renderProjects();
                        }
                    }
                }, err => {
                    console.error('Projects sync error:', err);
                });
            
            // Tasks listener
            unsubscribeTasks = db.collection('users').doc(currentUser.uid)
                .collection('tasks')
                .orderBy('faelligAm', 'asc')
                .onSnapshot(snapshot => {
                    tasks = [];
                    snapshot.forEach(doc => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });
                    // Tasks-Tab aktualisieren wenn sichtbar
                    if (document.getElementById('content-tasks').classList.contains('hidden') === false) {
                        renderTasks();
                    }
                    // Startbildschirm zeigen beim ersten Laden (wenn dringende Aufgaben)
                    if (!tasksDashboardShown) {
                        showTasksDashboardOnStart();
                    }
                    setSyncStatus('synced');
                }, err => {
                    console.error('Tasks sync error:', err);
                    setSyncStatus('error');
                });
        }

        function cleanupSync() {
            if (unsubscribeEntries) unsubscribeEntries();
            if (unsubscribeProjects) unsubscribeProjects();
            if (unsubscribeTasks) unsubscribeTasks();
        }

        async function initializeProjects() {
            const batch = db.batch();
            Object.entries(INITIAL_PROJECTS).forEach(([key, value]) => {
                const safeKey = sanitizeProjectKey(key);
                const ref = db.collection('users').doc(currentUser.uid).collection('projects').doc(safeKey);
                batch.set(ref, value);
            });
            await batch.commit();
        }

        function setSyncStatus(status) {
            const el = document.getElementById('syncStatus');
            el.classList.remove('syncing');
            
            switch(status) {
                case 'syncing':
                    el.innerHTML = 'üîÑ Sync...';
                    el.className = 'sync-indicator syncing text-xs bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded-full';
                    break;
                case 'synced':
                    el.innerHTML = '‚òÅÔ∏è Sync';
                    el.className = 'sync-indicator text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded-full';
                    break;
                case 'error':
                    el.innerHTML = '‚ö†Ô∏è Offline';
                    el.className = 'sync-indicator text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded-full';
                    break;
            }
        }

        // ==================== FIRESTORE OPERATIONS ====================
        async function addEntry(entry) {
            if (!currentUser) return;
            setSyncStatus('syncing');
            try {
                await db.collection('users').doc(currentUser.uid).collection('entries').add(entry);
                setSyncStatus('synced');
            } catch (err) {
                console.error('Add entry error:', err);
                setSyncStatus('error');
            }
        }

        async function updateEntry(id, data) {
            if (!currentUser) return;
            setSyncStatus('syncing');
            try {
                await db.collection('users').doc(currentUser.uid).collection('entries').doc(id).update(data);
                setSyncStatus('synced');
            } catch (err) {
                console.error('Update entry error:', err);
                setSyncStatus('error');
            }
        }

        async function deleteEntryFromDB(id) {
            if (!currentUser) return;
            setSyncStatus('syncing');
            try {
                await db.collection('users').doc(currentUser.uid).collection('entries').doc(id).delete();
                setSyncStatus('synced');
            } catch (err) {
                console.error('Delete entry error:', err);
                setSyncStatus('error');
            }
        }

        async function addProjectToDB(name, data) {
            if (!currentUser) return;
            const safeKey = sanitizeProjectKey(name);
            try {
                await db.collection('users').doc(currentUser.uid).collection('projects').doc(safeKey).set(data);
            } catch (err) {
                console.error('Add project error:', err);
            }
        }

        async function deleteProjectFromDB(name) {
            if (!currentUser) return;
            const safeKey = sanitizeProjectKey(name);
            try {
                await db.collection('users').doc(currentUser.uid).collection('projects').doc(safeKey).delete();
            } catch (err) {
                console.error('Delete project error:', err);
            }
        }

        async function renameProjectInDB(oldName, newName) {
            if (!currentUser) return;
            const oldSafeKey = sanitizeProjectKey(oldName);
            const newSafeKey = sanitizeProjectKey(newName);
            try {
                const oldData = projects[oldName];
                await db.collection('users').doc(currentUser.uid).collection('projects').doc(newSafeKey).set({
                    ...oldData,
                    name: newName
                });
                await db.collection('users').doc(currentUser.uid).collection('projects').doc(oldSafeKey).delete();
                
                // Update all entries with old project name
                const batch = db.batch();
                entries.filter(e => e.projekt === oldName).forEach(e => {
                    const ref = db.collection('users').doc(currentUser.uid).collection('entries').doc(e.id);
                    batch.update(ref, { projekt: newName });
                });
                await batch.commit();
            } catch (err) {
                console.error('Rename project error:', err);
            }
        }

        // ==================== UI INIT ====================
        function initUI() {
            document.getElementById('manualDate').value = getToday();
            updateProjectSelects();
            
            // Sortierreihenfolge aus localStorage laden
            const savedSortOrder = localStorage.getItem('zeiterfassung_sortOrder');
            if (savedSortOrder === 'asc') {
                sortOrderDescending = false;
                document.getElementById('btnSortOrder').innerHTML = '‚¨ÜÔ∏è';
                document.getElementById('btnSortOrder').title = 'Sortierung: √Ñlteste zuerst';
            }
            
            // Notification-Button Status aktualisieren
            updateNotificationButton();
            
            // Aufgaben-Datum auf heute setzen
            document.getElementById('newTaskDue').value = getToday();
            
            updateTodayView();
        }

        // ==================== TABS ====================
        function showTab(tabName) {
            ['timer', 'tasks', 'entries', 'projects', 'dashboard', 'export'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
                document.getElementById(`tab-${t}`).classList.add('text-br-200');
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            document.getElementById(`tab-${tabName}`).classList.remove('text-br-200');

            if (tabName === 'entries') filterEntries();
            if (tabName === 'projects') renderProjects();
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'tasks') renderTasks();
        }

        // ==================== TIMER ====================
        function toggleTimer() {
            if (isRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            const useCountdown = document.getElementById('useCountdown').checked;
            
            // Audio f√ºr Alarm vorbereiten (muss bei User-Klick passieren!)
            initAudioContext();
            
            // Benachrichtigungs-Berechtigung anfordern (wichtig f√ºr Hintergrund-Alarm!)
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        setupFCM();
                        showToast('‚úÖ Benachrichtigungen aktiviert!');
                    }
                });
            } else if (Notification.permission === 'granted' && !fcmToken) {
                // FCM Token holen falls noch nicht vorhanden
                setupFCM();
            }
            
            // Countdown-Dauer merken
            const countdownMinutes = parseInt(document.getElementById('countdownMinutes').value) || 60;
            const projekt = document.getElementById('currentProject').value;
            
            if (useCountdown) {
                timerSeconds = countdownMinutes * 60;
                
                // ‚òÅÔ∏è Cloud Timer f√ºr Push-Notification speichern
                const alarmTime = Date.now() + (countdownMinutes * 60 * 1000);
                saveCloudTimer(alarmTime, projekt);
            } else {
                timerSeconds = 0;
            }
            
            timerStart = new Date();
            isRunning = true;
            
            document.getElementById('btnStartStop').innerHTML = '‚è∏Ô∏è Stop';
            document.getElementById('btnStartStop').classList.remove('bg-green-600', 'hover:bg-green-500');
            document.getElementById('btnStartStop').classList.add('bg-red-600', 'hover:bg-red-500');
            document.getElementById('timerDisplay').classList.add('timer-active');
            document.getElementById('timerStatus').textContent = useCountdown ? '‚è±Ô∏è Countdown l√§uft... (Cloud-Alarm aktiv ‚òÅÔ∏è)' : 'Timer l√§uft...';
            
            saveTimerState();
            
            // Timer basiert auf echter Startzeit, nicht auf Sekunden-Z√§hlung
            timerInterval = setInterval(() => {
                const now = new Date();
                const elapsedSeconds = Math.floor((now - timerStart) / 1000);
                
                if (useCountdown) {
                    timerSeconds = Math.max(0, (countdownMinutes * 60) - elapsedSeconds);
                    if (timerSeconds <= 0) {
                        timerSeconds = 0;
                        stopTimer();
                        notifyTimerEnd();
                    }
                } else {
                    timerSeconds = elapsedSeconds;
                }
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            
            document.getElementById('btnStartStop').innerHTML = '‚ñ∂Ô∏è Start';
            document.getElementById('btnStartStop').classList.remove('bg-red-600', 'hover:bg-red-500');
            document.getElementById('btnStartStop').classList.add('bg-green-600', 'hover:bg-green-500');
            document.getElementById('timerDisplay').classList.remove('timer-active');
            document.getElementById('timerStatus').textContent = 'Timer gestoppt';
            
            // Zeiteintrag speichern wenn Timer > 1 Minute gelaufen ist
            if (timerStart) {
                const elapsedSeconds = Math.floor((new Date() - timerStart) / 1000);
                if (elapsedSeconds > 60) {
                    saveTimerEntry();
                }
            }
            
            // ‚òÅÔ∏è Cloud Timer deaktivieren
            clearCloudTimer();
            clearTimerState();
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            timerSeconds = 0;
            timerStart = null;
            
            document.getElementById('btnStartStop').innerHTML = '‚ñ∂Ô∏è Start';
            document.getElementById('btnStartStop').classList.remove('bg-red-600', 'hover:bg-red-500');
            document.getElementById('btnStartStop').classList.add('bg-green-600', 'hover:bg-green-500');
            document.getElementById('timerDisplay').classList.remove('timer-active');
            document.getElementById('timerStatus').textContent = 'Bereit zum Starten';
            updateTimerDisplay();
            
            // ‚òÅÔ∏è Cloud Timer deaktivieren
            clearCloudTimer();
            clearTimerState();
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timerSeconds / 3600);
            const minutes = Math.floor((timerSeconds % 3600) / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('timerValue').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function toggleCountdownMode() {
            const checked = document.getElementById('useCountdown').checked;
            document.getElementById('countdownMinutes').disabled = !checked;
        }

        function saveTimerEntry() {
            const useCountdown = document.getElementById('useCountdown').checked;
            const projektSelect = document.getElementById('currentProject');
            const activity = document.getElementById('currentActivity').value;
            
            let endTime;
            if (useCountdown) {
                // Bei Countdown: Endzeit = Startzeit + eingestellte Minuten
                const countdownMinutes = parseInt(document.getElementById('countdownMinutes').value) || 60;
                endTime = new Date(timerStart.getTime() + (countdownMinutes * 60 * 1000));
            } else {
                // Bei Stoppuhr: Endzeit = jetzt
                endTime = new Date();
            }
            
            const entry = {
                datum: timerStart.toISOString().split('T')[0],
                start: timerStart.toTimeString().slice(0, 5),
                ende: endTime.toTimeString().slice(0, 5),
                projekt: projektSelect.value,
                taetigkeit: activity,
                homeoffice: isHomeoffice,
                stunden: calculateHours(timerStart.toTimeString().slice(0, 5), endTime.toTimeString().slice(0, 5)),
                pause: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (checkTimeConflict(entry)) {
                if (!confirm('‚ö†Ô∏è Zeitkonflikt erkannt! Trotzdem speichern?')) {
                    return;
                }
            }
            
            addEntry(entry);
            timerStart = null;
            showToast('‚úÖ Zeiteintrag gespeichert!');
        }

        function saveTimerState() {
            localStorage.setItem('zeiterfassung_timer', JSON.stringify({
                timerStart: timerStart?.toISOString(),
                isRunning,
                isCountdown: document.getElementById('useCountdown').checked,
                countdownMinutes: document.getElementById('countdownMinutes').value,
                project: document.getElementById('currentProject').value,
                activity: document.getElementById('currentActivity').value,
                homeoffice: isHomeoffice
            }));
        }

        function clearTimerState() {
            localStorage.removeItem('zeiterfassung_timer');
        }

        function restoreTimerState() {
            const saved = localStorage.getItem('zeiterfassung_timer');
            if (!saved) return;
            
            const state = JSON.parse(saved);
            if (!state.isRunning || !state.timerStart) return;
            
            const startTime = new Date(state.timerStart);
            const elapsed = Math.floor((Date.now() - startTime.getTime()) / 1000);
            const countdownMinutes = parseInt(state.countdownMinutes) || 60;
            
            timerStart = startTime;
            document.getElementById('currentProject').value = state.project || '';
            document.getElementById('currentActivity').value = state.activity || '';
            isHomeoffice = state.homeoffice;
            updateLocationButtons();
            
            if (state.isCountdown) {
                document.getElementById('useCountdown').checked = true;
                document.getElementById('countdownMinutes').value = countdownMinutes;
                document.getElementById('countdownMinutes').disabled = false;
                timerSeconds = Math.max(0, (countdownMinutes * 60) - elapsed);
                
                // Countdown abgelaufen w√§hrend App geschlossen war?
                if (timerSeconds <= 0) {
                    timerSeconds = 0;
                    clearTimerState();
                    notifyTimerEnd();
                    return;
                }
            } else {
                timerSeconds = elapsed;
            }
            
            isRunning = true;
            document.getElementById('btnStartStop').innerHTML = '‚è∏Ô∏è Stop';
            document.getElementById('btnStartStop').classList.remove('bg-green-600', 'hover:bg-green-500');
            document.getElementById('btnStartStop').classList.add('bg-red-600', 'hover:bg-red-500');
            document.getElementById('timerDisplay').classList.add('timer-active');
            document.getElementById('timerStatus').textContent = '‚úÖ Timer wiederhergestellt!';
            showToast(`‚è±Ô∏è Timer wiederhergestellt! L√§uft seit ${formatTimerDuration(elapsed)}`);
            
            // Audio vorbereiten f√ºr m√∂glichen Alarm
            initAudioContext();
            
            function formatTimerDuration(seconds) {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                if (h > 0) return `${h}h ${m}min`;
                return `${m} Minuten`;
            }
            
            updateTimerDisplay();
            
            // Timer basiert auf echter Startzeit
            timerInterval = setInterval(() => {
                const now = new Date();
                const elapsedNow = Math.floor((now - timerStart) / 1000);
                
                if (state.isCountdown) {
                    timerSeconds = Math.max(0, (countdownMinutes * 60) - elapsedNow);
                    if (timerSeconds <= 0) {
                        timerSeconds = 0;
                        stopTimer();
                        notifyTimerEnd();
                    }
                } else {
                    timerSeconds = elapsedNow;
                }
                updateTimerDisplay();
            }, 1000);
        }

        function notifyTimerEnd() {
            // 1. System-Benachrichtigung (funktioniert auch im Hintergrund!)
            sendSystemNotification();
            
            // 2. Vibration auf Mobilger√§ten (3x kurz)
            if ('vibrate' in navigator) {
                navigator.vibrate([500, 200, 500, 200, 500, 200, 500]);
            }
            
            // 3. Sound versuchen (funktioniert nur wenn App aktiv)
            tryPlayAlarmSound();
            
            // 4. Visuelles Modal
            showAlarmModal();
        }
        
        function sendSystemNotification() {
            if (!('Notification' in window)) return;
            
            if (Notification.permission === 'granted') {
                // Notification mit Tag damit sie nicht doppelt erscheint
                const notification = new Notification('‚è∞ Zeit abgelaufen!', {
                    body: 'Dein Countdown ist beendet.',
                    icon: 'icon-192.png',
                    tag: 'timer-alarm',
                    requireInteraction: true, // Bleibt bis User reagiert
                    silent: false // System-Sound abspielen!
                });
                
                // Bei Klick auf Notification: App in Vordergrund
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            } else if (Notification.permission === 'default') {
                // Berechtigung noch nicht erteilt - f√ºr n√§chstes Mal anfordern
                Notification.requestPermission();
            }
        }
        
        function playAlarmSound() {
            // Globalen Audio Context verwenden (wurde beim Timer-Start aktiviert)
            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Context reaktivieren falls suspended
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                
                // Alarm-Melodie: 3 aufsteigende T√∂ne, 2x wiederholt
                const playToneSequence = (startTime, baseFreq) => {
                    [0, 0.2, 0.4].forEach((delay, i) => {
                        const oscillator = audioCtx.createOscillator();
                        const gainNode = audioCtx.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioCtx.destination);
                        
                        // Aufsteigende T√∂ne
                        oscillator.frequency.value = baseFreq + (i * 100);
                        oscillator.type = 'sine';
                        
                        const t = startTime + delay;
                        gainNode.gain.setValueAtTime(0.4, t);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, t + 0.18);
                        
                        oscillator.start(t);
                        oscillator.stop(t + 0.2);
                    });
                };
                
                const now = audioCtx.currentTime;
                playToneSequence(now, 660);        // Erste Sequenz
                playToneSequence(now + 0.8, 880);  // Zweite Sequenz (h√∂her)
                playToneSequence(now + 1.6, 660);  // Dritte Sequenz
                playToneSequence(now + 2.4, 1047); // Finale (noch h√∂her)
                
            } catch (e) {
                console.log('Audio Fehler:', e);
            }
        }
        
        function showAlarmModal() {
            // Alarm-Modal erstellen
            const modal = document.createElement('div');
            modal.id = 'alarmModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="absolute inset-0 bg-red-900/80 alarm-flash"></div>
                <div class="relative bg-br-800 rounded-2xl p-8 m-4 max-w-sm w-full border-4 border-red-500 shadow-2xl text-center z-10">
                    <div class="text-6xl mb-4 animate-bounce">‚è∞</div>
                    <h2 class="text-2xl font-bold text-red-400 mb-2">Zeit abgelaufen!</h2>
                    <p class="text-gray-300 mb-6">Dein Countdown ist beendet.</p>
                    <button onclick="playAlarmAndClose()" class="w-full py-4 bg-green-600 hover:bg-green-500 rounded-xl text-lg font-bold transition-all flex items-center justify-center gap-2">
                        ‚úÖ OK
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Blink-Animation per CSS
            const style = document.createElement('style');
            style.id = 'alarmStyle';
            style.textContent = `
                @keyframes alarm-flash {
                    0%, 100% { opacity: 0.8; }
                    50% { opacity: 0.5; }
                }
                .alarm-flash {
                    animation: alarm-flash 0.5s ease-in-out infinite;
                }
            `;
            document.head.appendChild(style);
            
            // Versuche Sound abzuspielen (funktioniert evtl. nicht aus Hintergrund)
            tryPlayAlarmSound();
        }
        
        function tryPlayAlarmSound() {
            // Versuche AudioContext zu reaktivieren
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    playAlarmSound();
                }).catch(() => {
                    console.log('Audio konnte nicht aktiviert werden - User-Interaktion n√∂tig');
                });
            } else {
                playAlarmSound();
            }
        }
        
        function playAlarmAndClose() {
            // Nur Modal schlie√üen, kein Sound mehr (der Alarm hat ja bereits gel√§utet)
            closeAlarmModal();
        }
        
        function closeAlarmModal() {
            const modal = document.getElementById('alarmModal');
            const style = document.getElementById('alarmStyle');
            if (modal) modal.remove();
            if (style) style.remove();
        }
        
        function testAlarm() {
            try {
                // Audio Context initialisieren (durch User-Klick)
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('AudioContext erstellt');
                }
                
                // Context reaktivieren falls suspended
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        console.log('AudioContext resumed');
                        playTestSound();
                    });
                } else {
                    console.log('AudioContext state:', audioCtx.state);
                    playTestSound();
                }
            } catch (e) {
                console.error('Audio Fehler:', e);
                alert('‚ùå Audio nicht verf√ºgbar: ' + e.message);
            }
        }
        
        function playTestSound() {
            try {
                // Einfacher, lauter Testton
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                // Volle Lautst√§rke
                gainNode.gain.setValueAtTime(1.0, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.5);
                
                showToast('üîî Alarm-Test!');
                console.log('Sound abgespielt');
            } catch (e) {
                console.error('PlayTestSound Fehler:', e);
                alert('‚ùå Sound konnte nicht abgespielt werden: ' + e.message);
            }
        }
        
        async function activateNotifications() {
            if (!('Notification' in window)) {
                alert('‚ùå Dein Browser unterst√ºtzt keine Benachrichtigungen.');
                return;
            }
            
            if (Notification.permission === 'granted') {
                // Bereits berechtigt - Token holen/aktualisieren
                await setupFCM();
                updateNotificationButton();
                showToast('‚úÖ Benachrichtigungen sind aktiv!');
            } else if (Notification.permission === 'denied') {
                alert('‚ùå Benachrichtigungen sind blockiert.\n\n' +
                      'üì± iPhone: Einstellungen ‚Üí Safari ‚Üí Erweitert ‚Üí Website-Daten ‚Üí Erlauben\n\n' +
                      'Oder: App zum Home-Bildschirm hinzuf√ºgen und dort Benachrichtigungen erlauben.');
                updateNotificationButton();
            } else {
                // Berechtigung anfragen
                const permission = await Notification.requestPermission();
                updateNotificationButton();
                if (permission === 'granted') {
                    await setupFCM();
                    showToast('‚úÖ Benachrichtigungen aktiviert!');
                }
            }
        }
        
        async function setupFCM() {
            console.log('üîß setupFCM gestartet...');
            console.log('  - messaging vorhanden:', !!messaging);
            console.log('  - currentUser vorhanden:', !!currentUser);
            
            if (!currentUser) {
                console.error('‚ùå Kein User angemeldet');
                return;
            }
            
            if (!messaging) {
                console.error('‚ùå Firebase Messaging nicht verf√ºgbar (evtl. Safari?)');
                showToast('‚ö†Ô∏è Push nicht verf√ºgbar in diesem Browser');
                return;
            }
            
            try {
                // Service Worker registrieren
                console.log('üìù Registriere Service Worker...');
                const registration = await navigator.serviceWorker.register('firebase-messaging-sw.js');
                console.log('‚úÖ SW registriert:', registration);
                
                // FCM Token holen
                console.log('üîë Hole FCM Token...');
                fcmToken = await messaging.getToken({
                    vapidKey: 'BBRNUyM5qzGVioE4RXhFswL2O2ADFZ5Es5SS2E6jTshw_NUSdPuyUYc7HnD-kL8VZfldCYAwrDbKJlevOusirPI',
                    serviceWorkerRegistration: registration
                });
                
                if (fcmToken) {
                    console.log('‚úÖ FCM Token erhalten:', fcmToken.substring(0, 20) + '...');
                    
                    // Pr√ºfe ob Token schon existiert
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    const userData = userDoc.data() || {};
                    
                    // Finde freien Slot f√ºr Token
                    let tokenKey = 'fcmToken';
                    let tokenExists = false;
                    
                    // Pr√ºfe ob Token schon gespeichert ist
                    if (userData.fcmToken === fcmToken) tokenExists = true;
                    for (let i = 0; i <= 10; i++) {
                        if (userData[`fcmToken${i}`] === fcmToken) tokenExists = true;
                    }
                    
                    if (tokenExists) {
                        console.log('‚ÑπÔ∏è Token bereits gespeichert');
                        showToast('üîî Push bereits aktiv f√ºr dieses Ger√§t!');
                        updateNotificationButton();
                        return;
                    }
                    
                    // Finde freien Slot
                    if (userData.fcmToken) {
                        for (let i = 0; i <= 10; i++) {
                            if (!userData[`fcmToken${i}`]) {
                                tokenKey = `fcmToken${i}`;
                                break;
                            }
                        }
                    }
                    
                    // Token speichern
                    await db.collection('users').doc(currentUser.uid).set({
                        [tokenKey]: fcmToken,
                        fcmTokenUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    console.log(`‚úÖ FCM Token gespeichert als ${tokenKey}`);
                    showToast('üîî Push f√ºr dieses Ger√§t aktiviert!');
                    updateNotificationButton();
                } else {
                    console.error('‚ùå Kein Token erhalten');
                    showToast('‚ö†Ô∏è Token konnte nicht erstellt werden');
                }
            } catch (error) {
                console.error('‚ùå FCM Setup Fehler:', error);
                showToast('‚ö†Ô∏è Fehler: ' + error.message);
            }
        }
        
        // Timer in Firestore speichern f√ºr Cloud Function
        async function saveCloudTimer(alarmTime, project) {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('timers').doc('current').set({
                        alarmTime: alarmTime,
                        project: project || '',
                        active: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                console.log('‚òÅÔ∏è Cloud Timer gespeichert, Alarm um:', new Date(alarmTime).toLocaleTimeString());
            } catch (error) {
                console.error('Cloud Timer Fehler:', error);
            }
        }
        
        // Cloud Timer l√∂schen
        async function clearCloudTimer() {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('timers').doc('current').update({
                        active: false
                    });
                console.log('‚òÅÔ∏è Cloud Timer deaktiviert');
            } catch (error) {
                console.error('Cloud Timer l√∂schen Fehler:', error);
            }
        }
        
        // Test Push-Notification √ºber Cloud Function
        async function testPushNotification() {
            if (!currentUser) {
                alert('Bitte erst anmelden!');
                return;
            }
            
            try {
                showToast('üì§ Sende Test-Notification...');
                const testNotification = functions.httpsCallable('testNotification');
                const result = await testNotification();
                console.log('Test Notification Result:', result);
                showToast('‚úÖ Test-Notification gesendet!');
            } catch (error) {
                console.error('Test Notification Fehler:', error);
                alert('‚ùå Fehler: ' + error.message);
            }
        }
        
        function updateNotificationButton() {
            const btn = document.getElementById('btnNotifyStatus');
            if (!btn) return;
            
            if (!('Notification' in window)) {
                btn.innerHTML = '‚ùå Nicht unterst√ºtzt';
                btn.className = 'w-full py-2 bg-br-700 rounded-lg text-sm font-medium opacity-50';
                return;
            }
            
            switch(Notification.permission) {
                case 'granted':
                    btn.innerHTML = 'üîî Benachrichtigungen aktiv';
                    btn.className = 'w-full py-2 bg-green-700 hover:bg-green-600 rounded-lg text-sm font-medium';
                    break;
                case 'denied':
                    btn.innerHTML = 'üîï Benachrichtigungen blockiert';
                    btn.className = 'w-full py-2 bg-red-700 hover:bg-red-600 rounded-lg text-sm font-medium';
                    break;
                default:
                    btn.innerHTML = 'üîï Benachrichtigungen aktivieren';
                    btn.className = 'w-full py-2 bg-yellow-700 hover:bg-yellow-600 rounded-lg text-sm font-medium';
            }
        }

        // ==================== LOCATION ====================
        function setLocation(homeoffice) {
            isHomeoffice = homeoffice;
            updateLocationButtons();
        }

        function updateLocationButtons() {
            const btnHO = document.getElementById('btn-ho');
            const btnOffice = document.getElementById('btn-office');
            
            if (isHomeoffice) {
                btnHO.classList.add('bg-br-500');
                btnHO.classList.remove('bg-br-700');
                btnOffice.classList.add('bg-br-700');
                btnOffice.classList.remove('bg-br-500');
            } else {
                btnOffice.classList.add('bg-br-500');
                btnOffice.classList.remove('bg-br-700');
                btnHO.classList.add('bg-br-700');
                btnHO.classList.remove('bg-br-500');
            }
        }

        // ==================== ENTRIES ====================
        function addManualEntry() {
            const datum = document.getElementById('manualDate').value;
            const start = document.getElementById('manualStart').value;
            const ende = document.getElementById('manualEnd').value;
            const projekt = document.getElementById('currentProject').value;
            const activity = document.getElementById('currentActivity').value;
            
            if (!datum || !start || !ende) {
                alert('Bitte Datum, Start und Ende eingeben!');
                return;
            }
            
            const entry = {
                datum,
                start,
                ende,
                projekt,
                taetigkeit: activity,
                homeoffice: isHomeoffice,
                stunden: calculateHours(start, ende),
                pause: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (checkTimeConflict(entry)) {
                if (!confirm('‚ö†Ô∏è Zeitkonflikt erkannt! Trotzdem speichern?')) {
                    return;
                }
            }
            
            addEntry(entry);
            showToast('‚úÖ Eintrag hinzugef√ºgt!');
            
            document.getElementById('manualStart').value = '';
            document.getElementById('manualEnd').value = '';
        }

        function checkTimeConflict(newEntry) {
            const sameDayEntries = entries.filter(e => e.datum === newEntry.datum && e.id !== newEntry.id);
            
            const newStart = timeToMinutes(newEntry.start);
            const newEnd = timeToMinutes(newEntry.ende);
            
            for (const entry of sameDayEntries) {
                const existStart = timeToMinutes(entry.start);
                const existEnd = timeToMinutes(entry.ende);
                
                if (newStart < existEnd && newEnd > existStart) {
                    return true;
                }
            }
            return false;
        }

        function timeToMinutes(time) {
            if (!time) return 0;
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        }

        function calculateHours(start, ende) {
            const startMin = timeToMinutes(start);
            const endMin = timeToMinutes(ende);
            return Math.round((endMin - startMin) / 60 * 100) / 100;
        }

        function updateTodayView() {
            const today = getToday();
            const todayEntries = entries.filter(e => e.datum === today).sort((a, b) => {
                if (sortOrderDescending) {
                    return (b.start || '').localeCompare(a.start || '');
                } else {
                    return (a.start || '').localeCompare(b.start || '');
                }
            });
            
            const container = document.getElementById('todayEntries');
            
            if (todayEntries.length === 0) {
                container.innerHTML = '<div class="p-4 text-br-300 text-center text-sm">Keine Eintr√§ge heute</div>';
            } else {
                container.innerHTML = todayEntries.map(e => `
                    <div class="flex items-center gap-3 p-3 border-b border-br-600 hover:bg-br-700/50">
                        <div class="w-1 h-10 rounded" style="background: ${projects[e.projekt]?.color || '#6B7280'}"></div>
                        <div class="flex-1">
                            <div class="text-sm font-medium">${e.start} - ${e.ende}</div>
                            <div class="text-xs text-br-200">${e.projekt || 'Allgemein'}${e.taetigkeit ? ' ‚Ä¢ ' + e.taetigkeit : ''}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-mono">${(e.stunden || 0).toFixed(2)}h</div>
                            <div class="text-xs">${e.homeoffice ? 'üè†' : 'üè¢'}</div>
                        </div>
                        <button onclick="editEntry('${e.id}')" class="p-2 hover:bg-br-600 rounded">‚úèÔ∏è</button>
                        <button onclick="deleteEntry('${e.id}')" class="p-2 hover:bg-red-900 rounded">üóëÔ∏è</button>
                    </div>
                `).join('');
            }
            
            const totalHours = todayEntries.reduce((sum, e) => sum + (e.stunden || 0), 0);
            document.getElementById('todayTotal').textContent = totalHours.toFixed(2) + ' h';
        }

        function toggleSortOrder() {
            sortOrderDescending = !sortOrderDescending;
            localStorage.setItem('zeiterfassung_sortOrder', sortOrderDescending ? 'desc' : 'asc');
            
            const btn = document.getElementById('btnSortOrder');
            if (sortOrderDescending) {
                btn.innerHTML = '‚¨áÔ∏è';
                btn.title = 'Sortierung: Neueste zuerst';
                showToast('üìÖ Sortierung: Neueste zuerst');
            } else {
                btn.innerHTML = '‚¨ÜÔ∏è';
                btn.title = 'Sortierung: √Ñlteste zuerst';
                showToast('üìÖ Sortierung: √Ñlteste zuerst');
            }
            filterEntries();
            updateTodayView();
        }

        // Pagination-Funktionen
        window.entriesPageSize = 50;
        window.entriesCurrentPage = 1;
        
        function changeEntriesPage(page) {
            window.entriesCurrentPage = page;
            filterEntries();
        }
        
        function changeEntriesPageSize(size) {
            window.entriesPageSize = parseInt(size);
            window.entriesCurrentPage = 1; // Zur√ºck zur ersten Seite
            // Beide Dropdowns synchronisieren
            const topSelect = document.getElementById('pageSizeTop');
            if (topSelect) topSelect.value = size;
            filterEntries();
        }

        function filterEntries() {
            const filterDate = document.getElementById('filterDate').value;
            const filterProject = document.getElementById('filterProject').value;
            
            // Bei Filter√§nderung Seite zur√ºcksetzen (au√üer wenn explizit Seite gewechselt wird)
            if (window.filterChanged) {
                window.entriesCurrentPage = 1;
                window.filterChanged = false;
            }
            
            let filtered = [...entries];
            
            if (filterDate) {
                filtered = filtered.filter(e => e.datum === filterDate);
            }
            
            if (filterProject) {
                filtered = filtered.filter(e => e.projekt === filterProject);
            }
            
            filtered.sort((a, b) => {
                if (sortOrderDescending) {
                    // Absteigend: Neueste zuerst
                    if (a.datum !== b.datum) return b.datum.localeCompare(a.datum);
                    return (b.start || '').localeCompare(a.start || '');
                } else {
                    // Aufsteigend: √Ñlteste zuerst
                    if (a.datum !== b.datum) return a.datum.localeCompare(b.datum);
                    return (a.start || '').localeCompare(b.start || '');
                }
            });
            
            const container = document.getElementById('entriesList');
            
            // Pagination-Einstellungen
            const pageSize = window.entriesPageSize || 50;
            const currentPage = window.entriesCurrentPage || 1;
            const totalPages = Math.ceil(filtered.length / pageSize);
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = startIdx + pageSize;
            const pageEntries = filtered.slice(startIdx, endIdx);
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="p-8 text-br-300 text-center">Keine Eintr√§ge gefunden</div>';
            } else {
                container.innerHTML = pageEntries.map(e => `
                    <div class="bg-br-800 rounded-lg p-3 border border-br-600 flex items-center gap-3">
                        <div class="w-1 h-12 rounded" style="background: ${projects[e.projekt]?.color || '#6B7280'}"></div>
                        <div class="flex-1">
                            <div class="text-sm font-medium">${formatDate(e.datum)}</div>
                            <div class="text-xs text-br-200">${e.start} - ${e.ende} ‚Ä¢ ${e.projekt || 'Allgemein'}</div>
                            ${e.taetigkeit ? `<div class="text-xs text-br-300">${e.taetigkeit}</div>` : ''}
                        </div>
                        <div class="text-right">
                            <div class="font-mono">${(e.stunden || 0).toFixed(2)}h</div>
                            <div class="text-xs">${e.homeoffice ? 'üè†' : 'üè¢'}</div>
                        </div>
                        <button onclick="editEntry('${e.id}')" class="p-2 hover:bg-br-600 rounded">‚úèÔ∏è</button>
                        <button onclick="deleteEntry('${e.id}')" class="p-2 hover:bg-red-900 rounded">üóëÔ∏è</button>
                    </div>
                `).join('');
                
                // Pagination-Steuerung hinzuf√ºgen
                if (totalPages > 1) {
                    container.innerHTML += `
                        <div class="flex items-center justify-center gap-2 mt-4 pt-4 border-t border-br-600">
                            <button onclick="changeEntriesPage(1)" ${currentPage === 1 ? 'disabled' : ''} 
                                class="px-3 py-1 rounded bg-br-700 hover:bg-br-600 disabled:opacity-50 disabled:cursor-not-allowed">‚èÆÔ∏è</button>
                            <button onclick="changeEntriesPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} 
                                class="px-3 py-1 rounded bg-br-700 hover:bg-br-600 disabled:opacity-50 disabled:cursor-not-allowed">‚óÄÔ∏è</button>
                            <span class="px-4 text-sm">Seite ${currentPage} von ${totalPages}</span>
                            <button onclick="changeEntriesPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} 
                                class="px-3 py-1 rounded bg-br-700 hover:bg-br-600 disabled:opacity-50 disabled:cursor-not-allowed">‚ñ∂Ô∏è</button>
                            <button onclick="changeEntriesPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''} 
                                class="px-3 py-1 rounded bg-br-700 hover:bg-br-600 disabled:opacity-50 disabled:cursor-not-allowed">‚è≠Ô∏è</button>
                        </div>
                    `;
                }
                
                // Seitengr√∂√üe-Auswahl immer anzeigen (auch bei "Alle anzeigen")
                container.innerHTML += `
                    <div class="flex justify-center gap-2 mt-${totalPages > 1 ? '2' : '4'} ${totalPages <= 1 ? 'pt-4 border-t border-br-600' : ''}">
                        <select onchange="changeEntriesPageSize(this.value)" class="bg-br-700 border border-br-600 rounded px-2 py-1 text-sm">
                            <option value="50" ${pageSize === 50 ? 'selected' : ''}>50 pro Seite</option>
                            <option value="100" ${pageSize === 100 ? 'selected' : ''}>100 pro Seite</option>
                            <option value="200" ${pageSize === 200 ? 'selected' : ''}>200 pro Seite</option>
                            <option value="99999" ${pageSize === 99999 ? 'selected' : ''}>Alle anzeigen</option>
                        </select>
                    </div>
                `;
            }
            
            const totalHours = filtered.reduce((sum, e) => sum + (e.stunden || 0), 0);
            const statsText = `${filtered.length} Eintr√§ge ‚Ä¢ ${totalHours.toFixed(2)} Stunden (${startIdx + 1}-${Math.min(endIdx, filtered.length)} angezeigt)`;
            document.getElementById('entriesStats').textContent = statsText;
            document.getElementById('entriesStatsTop').textContent = statsText;
            
            // Oberes Dropdown synchronisieren
            const topSelect = document.getElementById('pageSizeTop');
            if (topSelect) topSelect.value = pageSize;
        }

        function editEntry(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;
            
            editingEntryId = id;
            
            document.getElementById('editDate').value = entry.datum;
            document.getElementById('editStart').value = entry.start;
            document.getElementById('editEnd').value = entry.ende;
            document.getElementById('editActivity').value = entry.taetigkeit || '';
            document.getElementById('editLocation').value = String(entry.homeoffice);
            
            const select = document.getElementById('editProject');
            select.innerHTML = '<option value="">-- Kein Projekt --</option>' + 
                Object.keys(projects).map(p => `<option value="${p}" ${entry.projekt === p ? 'selected' : ''}>${p}</option>`).join('');
            
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
            editingEntryId = null;
        }

        function saveEdit() {
            if (!editingEntryId) return;
            
            const updatedData = {
                datum: document.getElementById('editDate').value,
                start: document.getElementById('editStart').value,
                ende: document.getElementById('editEnd').value,
                projekt: document.getElementById('editProject').value,
                taetigkeit: document.getElementById('editActivity').value,
                homeoffice: document.getElementById('editLocation').value === 'true',
                stunden: calculateHours(document.getElementById('editStart').value, document.getElementById('editEnd').value)
            };
            
            // Check conflict
            const tempEntry = { ...updatedData, id: editingEntryId };
            if (checkTimeConflict(tempEntry)) {
                if (!confirm('‚ö†Ô∏è Zeitkonflikt erkannt! Trotzdem speichern?')) {
                    return;
                }
            }
            
            updateEntry(editingEntryId, updatedData);
            closeEditModal();
            showToast('‚úÖ √Ñnderungen gespeichert!');
        }

        function deleteEntry(id) {
            if (!confirm('Eintrag wirklich l√∂schen?')) return;
            deleteEntryFromDB(id);
            showToast('üóëÔ∏è Eintrag gel√∂scht');
        }

        // ==================== PROJECTS ====================
        function updateProjectSelects() {
            const projectOptions = '<option value="">-- Kein Projekt --</option>' + 
                Object.keys(projects).sort().map(p => `<option value="${p}">${p}</option>`).join('');
            
            document.getElementById('currentProject').innerHTML = projectOptions;
            document.getElementById('filterProject').innerHTML = '<option value="">Alle Projekte</option>' + 
                Object.keys(projects).sort().map(p => `<option value="${p}">${p}</option>`).join('');
            
            // Event-Handler f√ºr Projektauswahl registrieren
            setupProjectChangeHandler();
        }

        // Event-Handler f√ºr automatische Zeitvoreinstellung bei AFT und Urlaub
        function setupProjectChangeHandler() {
            const projectSelect = document.getElementById('currentProject');
            if (projectSelect && !projectSelect.dataset.handlerAttached) {
                projectSelect.addEventListener('change', onProjectChange);
                projectSelect.dataset.handlerAttached = 'true';
            }
        }

        function onProjectChange() {
            const selectedProject = document.getElementById('currentProject').value;
            const manualStart = document.getElementById('manualStart');
            const manualEnd = document.getElementById('manualEnd');
            
            // Standardzeiten f√ºr AFT und Urlaub: 08:00 - 15:48 Uhr (7,8 Stunden)
            if (selectedProject === 'AFT' || selectedProject === 'Urlaub') {
                manualStart.value = '08:00';
                manualEnd.value = '15:48';
            } else {
                // F√ºr alle anderen Projekte: Felder leeren (nur wenn sie die Standardwerte haben)
                if (manualStart.value === '08:00' && manualEnd.value === '15:48') {
                    manualStart.value = '';
                    manualEnd.value = '';
                }
            }
        }

        function renderProjects() {
            const container = document.getElementById('projectsList');
            const projectKeys = Object.keys(projects).sort();
            
            container.innerHTML = projectKeys.map(p => {
                const projectHours = entries.filter(e => e.projekt === p).reduce((sum, e) => sum + (e.stunden || 0), 0);
                return `
                    <div class="bg-br-800 rounded-lg p-4 border border-br-600 flex items-center gap-3">
                        <div class="w-4 h-4 rounded" style="background: ${projects[p].color}"></div>
                        <div class="flex-1">
                            <div class="font-medium">${p}</div>
                            <div class="text-xs text-br-200">${projectHours.toFixed(2)} Stunden gesamt</div>
                        </div>
                        <button onclick="editProject('${p}')" class="p-2 hover:bg-br-600 rounded">‚úèÔ∏è</button>
                        <button onclick="deleteProject('${p}')" class="p-2 hover:bg-red-900 rounded">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        function addProject() {
            let name = document.getElementById('newProjectName').value.trim();
            const color = document.getElementById('newProjectColor').value;
            
            if (!name) {
                alert('Bitte Projektnamen eingeben!');
                return;
            }
            
            // Ersetze / durch - f√ºr Firebase-Kompatibilit√§t
            if (name.includes('/')) {
                name = name.replace(/\//g, '-');
                showToast('‚ÑπÔ∏è "/" wurde durch "-" ersetzt');
            }
            
            if (projects[name]) {
                alert('Projekt existiert bereits!');
                return;
            }
            
            addProjectToDB(name, { name, color });
            document.getElementById('newProjectName').value = '';
            showToast('‚úÖ Projekt erstellt!');
        }

        function editProject(oldName) {
            let newName = prompt('Neuer Projektname:', oldName);
            if (!newName || newName === oldName) return;
            
            // Ersetze / durch - f√ºr Firebase-Kompatibilit√§t
            if (newName.includes('/')) {
                newName = newName.replace(/\//g, '-');
                showToast('‚ÑπÔ∏è "/" wurde durch "-" ersetzt');
            }
            
            if (projects[newName]) {
                alert('Projekt existiert bereits!');
                return;
            }
            
            renameProjectInDB(oldName, newName);
            showToast('‚úÖ Projekt umbenannt!');
        }

        function deleteProject(name) {
            const count = entries.filter(e => e.projekt === name).length;
            if (!confirm(`Projekt "${name}" l√∂schen? (${count} Eintr√§ge werden nicht gel√∂scht)`)) return;
            
            deleteProjectFromDB(name);
            showToast('üóëÔ∏è Projekt gel√∂scht');
        }

        // ==================== DASHBOARD ====================
        function setDashboardPeriod(period) {
            dashboardPeriod = period;
            ['week', 'month', 'year', 'all', 'custom'].forEach(p => {
                const btn = document.getElementById(`dash-${p}`);
                if (btn) {
                    btn.classList.toggle('bg-br-500', p === period);
                    btn.classList.toggle('bg-br-700', p !== period);
                }
            });
            
            const dateRange = document.getElementById('dashboardDateRange');
            if (period === 'custom') {
                dateRange.classList.remove('hidden');
                // Standardwerte setzen falls leer
                const today = new Date();
                const monthAgo = new Date(today);
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                
                const fromInput = document.getElementById('dashFrom');
                const toInput = document.getElementById('dashTo');
                
                if (!fromInput.value) {
                    fromInput.value = monthAgo.toISOString().split('T')[0];
                }
                if (!toInput.value) {
                    toInput.value = today.toISOString().split('T')[0];
                }
                
                // Kurz warten damit die Werte gesetzt sind, dann Dashboard aktualisieren
                setTimeout(() => updateDashboard(), 50);
            } else {
                dateRange.classList.add('hidden');
                updateDashboard();
            }
        }

        function updateDashboard() {
            const filtered = getFilteredEntries(dashboardPeriod);
            
            const totalHours = filtered.reduce((sum, e) => sum + (e.stunden || 0), 0);
            const uniqueDays = [...new Set(filtered.map(e => e.datum))].length;
            const avgPerDay = uniqueDays > 0 ? totalHours / uniqueDays : 0;
            
            document.getElementById('statTotalHours').textContent = totalHours.toFixed(1);
            document.getElementById('statAvgPerDay').textContent = avgPerDay.toFixed(1);
            document.getElementById('statWorkDays').textContent = uniqueDays;
            document.getElementById('statEntries').textContent = filtered.length;
            
            const hoHours = filtered.filter(e => e.homeoffice).reduce((sum, e) => sum + (e.stunden || 0), 0);
            const officeHours = filtered.filter(e => !e.homeoffice).reduce((sum, e) => sum + (e.stunden || 0), 0);
            const total = hoHours + officeHours;
            
            const hoPct = total > 0 ? (hoHours / total * 100) : 50;
            const officePct = total > 0 ? (officeHours / total * 100) : 50;
            
            document.getElementById('statHomeoffice').textContent = hoPct.toFixed(0) + '%';
            document.getElementById('statOffice').textContent = officePct.toFixed(0) + '%';
            document.getElementById('hoBar').style.width = hoPct + '%';
            document.getElementById('officeBar').style.width = officePct + '%';
            
            const projectHours = {};
            filtered.forEach(e => {
                const p = e.projekt || 'Allgemein';
                projectHours[p] = (projectHours[p] || 0) + (e.stunden || 0);
            });
            
            const sortedProjects = Object.entries(projectHours).sort((a, b) => b[1] - a[1]);
            const maxHours = sortedProjects.length > 0 ? sortedProjects[0][1] : 1;
            
            document.getElementById('projectStats').innerHTML = sortedProjects.map(([name, hours]) => `
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded" style="background: ${projects[name]?.color || '#6B7280'}"></div>
                    <div class="flex-1 text-sm">${name}</div>
                    <div class="w-32 h-2 bg-br-700 rounded-full overflow-hidden">
                        <div class="h-full rounded-full" style="width: ${(hours/maxHours*100)}%; background: ${projects[name]?.color || '#6B7280'}"></div>
                    </div>
                    <div class="text-sm font-mono w-16 text-right">${hours.toFixed(1)}h</div>
                </div>
            `).join('');
        }

        function getFilteredEntries(period) {
            const today = new Date();
            today.setHours(23, 59, 59, 999); // Ende des Tages
            
            switch(period) {
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setHours(0, 0, 0, 0);
                    const dayOfWeek = weekStart.getDay();
                    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    weekStart.setDate(weekStart.getDate() + daysToMonday);
                    return entries.filter(e => e.datum && new Date(e.datum) >= weekStart);
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    return entries.filter(e => e.datum && new Date(e.datum) >= monthStart);
                case 'year':
                    const yearStart = new Date(today.getFullYear(), 0, 1);
                    return entries.filter(e => e.datum && new Date(e.datum) >= yearStart);
                case 'custom':
                    const fromEl = document.getElementById('dashFrom');
                    const toEl = document.getElementById('dashTo');
                    const from = fromEl ? fromEl.value : '';
                    const to = toEl ? toEl.value : '';
                    console.log('Custom Filter:', from, 'bis', to);
                    if (from && to) {
                        return entries.filter(e => e.datum && e.datum >= from && e.datum <= to);
                    }
                    console.log('Keine Datumsfilter gesetzt, zeige alle');
                    return entries;
                default:
                    return entries;
            }
        }

        // ==================== EXPORT ====================
        function toggleCustomDates() {
            const period = document.getElementById('exportPeriod').value;
            const customRange = document.getElementById('customDateRange');
            
            if (period === 'custom') {
                customRange.classList.remove('hidden');
                // Standardwerte setzen: Letzter Monat
                const today = new Date();
                const monthAgo = new Date(today);
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                
                if (!document.getElementById('exportFrom').value) {
                    document.getElementById('exportFrom').value = monthAgo.toISOString().split('T')[0];
                }
                if (!document.getElementById('exportTo').value) {
                    document.getElementById('exportTo').value = today.toISOString().split('T')[0];
                }
            } else {
                customRange.classList.add('hidden');
            }
        }

        function getExportEntries() {
            const period = document.getElementById('exportPeriod').value;
            const today = new Date();
            
            let filtered = [...entries];
            
            switch(period) {
                case 'today':
                    filtered = entries.filter(e => e.datum === getToday());
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setHours(0, 0, 0, 0);
                    const dayOfWeek = weekStart.getDay();
                    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    weekStart.setDate(weekStart.getDate() + daysToMonday);
                    filtered = entries.filter(e => new Date(e.datum) >= weekStart);
                    break;
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    filtered = entries.filter(e => new Date(e.datum) >= monthStart);
                    break;
                case 'year':
                    const yearStart = new Date(today.getFullYear(), 0, 1);
                    filtered = entries.filter(e => new Date(e.datum) >= yearStart);
                    break;
                case 'custom':
                    const from = document.getElementById('exportFrom').value;
                    const to = document.getElementById('exportTo').value;
                    if (from && to) {
                        filtered = entries.filter(e => e.datum >= from && e.datum <= to);
                    } else {
                        alert('Bitte Von- und Bis-Datum ausw√§hlen!');
                        return [];
                    }
                    break;
            }
            
            return filtered.sort((a, b) => {
                if (a.datum !== b.datum) return a.datum.localeCompare(b.datum);
                return (a.start || '').localeCompare(b.start || '');
            });
        }

        function exportXLSX() {
            const data = getExportEntries();
            if (data.length === 0) { alert('Keine Daten zum Exportieren'); return; }
            
            const wsData = [['Datum', 'Projekt', 'T√§tigkeit', 'Start', 'Ende', 'Stunden', 'Arbeitsort']];
            
            data.forEach(e => {
                wsData.push([e.datum, e.projekt || '', e.taetigkeit || '', e.start, e.ende, e.stunden || 0, e.homeoffice ? 'Homeoffice' : 'B√ºro']);
            });
            
            const totalHours = data.reduce((sum, e) => sum + (e.stunden || 0), 0);
            wsData.push([]);
            wsData.push(['Gesamt', '', '', '', '', totalHours, '']);
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = [{wch:12}, {wch:20}, {wch:25}, {wch:8}, {wch:8}, {wch:10}, {wch:12}];
            XLSX.utils.book_append_sheet(wb, ws, 'Zeiterfassung');
            XLSX.writeFile(wb, `Zeiterfassung_${getToday()}.xlsx`);
        }

        function mergeConsecutiveEntries(data) {
            // Sortieren nach Datum und Startzeit
            const sorted = [...data].sort((a, b) => {
                if (a.datum !== b.datum) return a.datum.localeCompare(b.datum);
                return (a.start || '').localeCompare(b.start || '');
            });
            
            const merged = [];
            let current = null;
            
            for (const entry of sorted) {
                if (!current) {
                    // Erster Eintrag
                    current = { 
                        datum: entry.datum,
                        start: entry.start,
                        ende: entry.ende,
                        projekte: [entry.projekt || 'Allgemein'],
                        taetigkeiten: entry.taetigkeit ? [entry.taetigkeit] : [],
                        homeoffice: entry.homeoffice,
                        stunden: entry.stunden || 0
                    };
                } else if (
                    current.datum === entry.datum &&
                    current.ende === entry.start
                ) {
                    // Nahtlos anschlie√üend - zusammenfassen (egal welches Projekt)
                    current.ende = entry.ende;
                    current.stunden = calculateHours(current.start, current.ende);
                    // Projekte sammeln
                    if (entry.projekt && !current.projekte.includes(entry.projekt)) {
                        current.projekte.push(entry.projekt);
                    }
                    // T√§tigkeiten sammeln
                    if (entry.taetigkeit && !current.taetigkeiten.includes(entry.taetigkeit)) {
                        current.taetigkeiten.push(entry.taetigkeit);
                    }
                } else {
                    // L√ºcke - neuer Eintrag
                    merged.push(current);
                    current = { 
                        datum: entry.datum,
                        start: entry.start,
                        ende: entry.ende,
                        projekte: [entry.projekt || 'Allgemein'],
                        taetigkeiten: entry.taetigkeit ? [entry.taetigkeit] : [],
                        homeoffice: entry.homeoffice,
                        stunden: entry.stunden || 0
                    };
                }
            }
            
            // Letzten Eintrag hinzuf√ºgen
            if (current) {
                merged.push(current);
            }
            
            return merged;
        }

        function exportPDF() {
            const rawData = getExportEntries();
            if (rawData.length === 0) { alert('Keine Daten zum Exportieren'); return; }
            
            // Zusammenh√§ngende Zeiten zusammenfassen
            const data = mergeConsecutiveEntries(rawData);
            
            const { jsPDF } = window.jspdf;
            // Querformat: 'l' = landscape
            const doc = new jsPDF('l', 'mm', 'a4');
            
            doc.setFontSize(18);
            doc.text('Zeiterfassung', 14, 22);
            doc.setFontSize(10);
            doc.text(`Erstellt am: ${formatDate(getToday())}`, 14, 30);
            doc.text(`${data.length} Zeitbl√∂cke (aus ${rawData.length} Eintr√§gen)`, 14, 36);
            
            let y = 50;
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('Datum', 14, y);
            doc.text('Projekte', 50, y);
            doc.text('T√§tigkeiten', 120, y);
            doc.text('Start', 200, y);
            doc.text('Ende', 220, y);
            doc.text('Stunden', 245, y);
            doc.text('Ort', 270, y);
            
            doc.setFont(undefined, 'normal');
            y += 8;
            
            data.forEach(e => {
                if (y > 190) { doc.addPage(); y = 20; }
                doc.text(formatDate(e.datum), 14, y);
                doc.text((e.projekte || []).join(', ').substring(0, 35), 50, y);
                doc.text((e.taetigkeiten || []).join(', ').substring(0, 40), 120, y);
                doc.text(e.start || '', 200, y);
                doc.text(e.ende || '', 220, y);
                doc.text((e.stunden || 0).toFixed(2), 245, y);
                doc.text(e.homeoffice ? 'HO' : 'B√ºro', 270, y);
                y += 6;
            });
            
            const totalHours = data.reduce((sum, e) => sum + (e.stunden || 0), 0);
            y += 5;
            doc.setFont(undefined, 'bold');
            doc.text(`Gesamt: ${totalHours.toFixed(2)} Stunden`, 14, y);
            
            doc.save(`Zeiterfassung_${getToday()}.pdf`);
        }

        function exportCSV() {
            const data = getExportEntries();
            if (data.length === 0) { alert('Keine Daten zum Exportieren'); return; }
            
            let csv = 'Datum;Projekt;T√§tigkeit;Start;Ende;Stunden;Arbeitsort\n';
            data.forEach(e => {
                csv += `${e.datum};${e.projekt || ''};${e.taetigkeit || ''};${e.start};${e.ende};${(e.stunden || 0).toFixed(2)};${e.homeoffice ? 'Homeoffice' : 'B√ºro'}\n`;
            });
            
            downloadFile(csv, `Zeiterfassung_${getToday()}.csv`, 'text/csv;charset=utf-8');
        }

        function exportJSON() {
            const data = {
                entries: getExportEntries(),
                projects,
                tasks: tasks.map(t => ({
                    aufgabe: t.aufgabe,
                    status: t.status,
                    prioritaet: t.prioritaet,
                    faelligAm: t.faelligAm,
                    erstelltAm: t.erstelltAm,
                    erledigtAm: t.erledigtAm,
                    notizen: t.notizen
                })),
                exportDate: new Date().toISOString()
            };
            
            downloadFile(JSON.stringify(data, null, 2), `Zeiterfassung_Backup_${getToday()}.json`, 'application/json');
        }

        async function importJSON() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    console.log('üì• Import gestartet:', data);
                    console.log('  - entries:', data.entries?.length || 0);
                    console.log('  - tasks:', data.tasks?.length || 0);
                    console.log('  - currentUser:', currentUser?.uid);
                    
                    let importedEntries = 0;
                    let importedTasks = 0;
                    
                    if (!currentUser) {
                        alert('‚ùå Bitte erst anmelden!');
                        return;
                    }
                    
                    setSyncStatus('syncing');
                    
                    // Zeiteintr√§ge importieren
                    if (data.entries && Array.isArray(data.entries)) {
                        console.log(`üìù Importiere ${data.entries.length} Eintr√§ge...`);
                        console.log(`  Lokale entries zum Vergleich: ${entries ? entries.length : 'undefined'}`);
                        
                        // Zeige ersten Eintrag zum Debug
                        if (data.entries.length > 0) {
                            console.log('  Erster Eintrag:', data.entries[0]);
                        }
                        
                        for (const entry of data.entries) {
                            // Check if entry already exists (by datum+start+ende)
                            const exists = entries && entries.length > 0 && entries.some(e => 
                                e.datum === entry.datum && 
                                e.start === entry.start && 
                                e.ende === entry.ende
                            );
                            
                            const hasData = entry.datum && entry.start;
                            
                            console.log(`  Entry: ${entry.datum} ${entry.start} - exists: ${exists}, hasData: ${hasData}`);
                            
                            if (!exists && hasData) {
                                await db.collection('users').doc(currentUser.uid).collection('entries').add({
                                    datum: entry.datum,
                                    start: entry.start,
                                    ende: entry.ende || '',
                                    projekt: entry.projekt || '',
                                    taetigkeit: entry.taetigkeit || '',
                                    homeoffice: entry.homeoffice || false,
                                    stunden: entry.stunden || 0,
                                    pause: entry.pause || 0,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                importedEntries++;
                                if (importedEntries % 50 === 0) {
                                    console.log(`  ... ${importedEntries} Eintr√§ge importiert`);
                                }
                            }
                            
                            // Nur ersten 5 loggen
                            if (importedEntries >= 5) break;
                        }
                        console.log(`‚úÖ ${importedEntries} Eintr√§ge importiert (Test-Modus: max 5)`);
                    }
                    
                    // Projekte importieren
                    if (data.projects) {
                        for (const [name, proj] of Object.entries(data.projects)) {
                            if (!projects[name]) {
                                await addProjectToDB(name, proj);
                            }
                        }
                    }
                    
                    // Tasks importieren
                    if (data.tasks && Array.isArray(data.tasks)) {
                        console.log(`üìù Importiere ${data.tasks.length} Aufgaben...`);
                        for (const task of data.tasks) {
                            // Check if task already exists (by aufgabe + erstelltAm)
                            const exists = tasks.some(t => 
                                t.aufgabe === task.aufgabe && 
                                t.erstelltAm === task.erstelltAm
                            );
                            
                            if (!exists) {
                                await db.collection('users').doc(currentUser.uid).collection('tasks').add({
                                    aufgabe: task.aufgabe || '',
                                    status: (task.status || 'offen').toLowerCase(),
                                    prioritaet: (task.prioritaet || 'mittel').toLowerCase(),
                                    faelligAm: task.faelligAm || null,
                                    erstelltAm: task.erstelltAm || getToday(),
                                    erledigtAm: task.erledigtAm || null,
                                    notizen: task.notizen || '',
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                importedTasks++;
                            }
                        }
                        console.log(`‚úÖ ${importedTasks} Aufgaben importiert`);
                    }
                    
                    setSyncStatus('synced');
                    
                    // Erfolgs-Nachricht
                    let msg = '‚úÖ Import abgeschlossen: ';
                    const parts = [];
                    if (importedEntries > 0) parts.push(`${importedEntries} Eintr√§ge`);
                    if (importedTasks > 0) parts.push(`${importedTasks} Aufgaben`);
                    if (parts.length === 0) {
                        msg = '‚ÑπÔ∏è Keine neuen Daten importiert (bereits vorhanden)';
                    } else {
                        msg += parts.join(', ');
                    }
                    showToast(msg);
                    
                } catch (err) {
                    console.error('‚ùå Import Fehler:', err);
                    alert('‚ùå Fehler beim Import: ' + err.message);
                    setSyncStatus('error');
                }
            };
            reader.readAsText(file);
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è ALLE Daten unwiderruflich l√∂schen?')) return;
            if (!confirm('Wirklich ALLE Eintr√§ge l√∂schen? Dies kann nicht r√ºckg√§ngig gemacht werden!')) return;
            
            setSyncStatus('syncing');
            
            // Delete all entries
            const entriesSnapshot = await db.collection('users').doc(currentUser.uid).collection('entries').get();
            const batch = db.batch();
            entriesSnapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            
            setSyncStatus('synced');
            showToast('üóëÔ∏è Alle Daten wurden gel√∂scht');
        }

        // ==================== TASKS / AUFGABEN ====================
        
        // Aufgabe hinzuf√ºgen
        async function addTask() {
            const title = document.getElementById('newTaskTitle').value.trim();
            if (!title) {
                showToast('‚ö†Ô∏è Bitte Aufgabe eingeben');
                return;
            }
            
            const task = {
                aufgabe: title,
                status: 'offen',
                prioritaet: document.getElementById('newTaskPriority').value || 'mittel',
                faelligAm: document.getElementById('newTaskDue').value || null,
                erstelltAm: getToday(),
                erledigtAm: null,
                notizen: document.getElementById('newTaskNotes').value.trim() || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            setSyncStatus('syncing');
            try {
                await db.collection('users').doc(currentUser.uid).collection('tasks').add(task);
                
                // Felder zur√ºcksetzen
                document.getElementById('newTaskTitle').value = '';
                document.getElementById('newTaskDue').value = '';
                document.getElementById('newTaskPriority').value = 'mittel';
                document.getElementById('newTaskNotes').value = '';
                
                showToast('‚úÖ Aufgabe hinzugef√ºgt');
                setSyncStatus('synced');
            } catch (err) {
                console.error('Add task error:', err);
                showToast('‚ùå Fehler beim Speichern');
                setSyncStatus('error');
            }
        }
        
        // Aufgabe-Status schnell √§ndern (Checkbox)
        async function toggleTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const newStatus = task.status.toLowerCase() === 'erledigt' ? 'offen' : 'erledigt';
            const erledigtAm = newStatus === 'erledigt' ? getToday() : null;
            
            // Sofort lokales Update f√ºr schnelle UI-Reaktion
            task.status = newStatus;
            task.erledigtAm = erledigtAm;
            renderTasks();
            
            setSyncStatus('syncing');
            try {
                await db.collection('users').doc(currentUser.uid).collection('tasks').doc(taskId).update({
                    status: newStatus,
                    erledigtAm: erledigtAm
                });
                setSyncStatus('synced');
            } catch (err) {
                console.error('Toggle task error:', err);
                // Bei Fehler zur√ºcksetzen
                task.status = newStatus === 'erledigt' ? 'offen' : 'erledigt';
                task.erledigtAm = newStatus === 'erledigt' ? null : getToday();
                renderTasks();
                setSyncStatus('error');
            }
        }
        
        // Task bearbeiten Modal √∂ffnen
        function editTask(taskId) {
            console.log('editTask aufgerufen mit ID:', taskId);
            const task = tasks.find(t => t.id === taskId);
            if (!task) {
                console.log('Task nicht gefunden!');
                return;
            }
            
            console.log('Task gefunden:', task);
            editingTaskId = taskId;
            document.getElementById('editTaskTitle').value = task.aufgabe || '';
            document.getElementById('editTaskDue').value = task.faelligAm || '';
            document.getElementById('editTaskPriority').value = (task.prioritaet || 'mittel').toLowerCase();
            document.getElementById('editTaskStatus').value = (task.status || 'offen').toLowerCase();
            document.getElementById('editTaskNotes').value = task.notizen || '';
            
            document.getElementById('editTaskModal').style.display = 'flex';
        }
        
        function closeEditTaskModal() {
            document.getElementById('editTaskModal').style.display = 'none';
            editingTaskId = null;
        }
        
        async function saveTaskEdit() {
            if (!editingTaskId) return;
            
            const status = document.getElementById('editTaskStatus').value;
            const erledigtAm = status === 'erledigt' ? (tasks.find(t => t.id === editingTaskId)?.erledigtAm || getToday()) : null;
            
            setSyncStatus('syncing');
            try {
                await db.collection('users').doc(currentUser.uid).collection('tasks').doc(editingTaskId).update({
                    aufgabe: document.getElementById('editTaskTitle').value.trim(),
                    faelligAm: document.getElementById('editTaskDue').value || null,
                    prioritaet: document.getElementById('editTaskPriority').value,
                    status: status,
                    erledigtAm: erledigtAm,
                    notizen: document.getElementById('editTaskNotes').value.trim()
                });
                closeEditTaskModal();
                showToast('‚úÖ Aufgabe aktualisiert');
                setSyncStatus('synced');
            } catch (err) {
                console.error('Save task error:', err);
                showToast('‚ùå Fehler beim Speichern');
                setSyncStatus('error');
            }
        }
        
        async function deleteTask() {
            if (!editingTaskId) return;
            if (!confirm('Aufgabe wirklich l√∂schen?')) return;
            
            setSyncStatus('syncing');
            try {
                await db.collection('users').doc(currentUser.uid).collection('tasks').doc(editingTaskId).delete();
                closeEditTaskModal();
                showToast('üóëÔ∏è Aufgabe gel√∂scht');
                setSyncStatus('synced');
            } catch (err) {
                console.error('Delete task error:', err);
                showToast('‚ùå Fehler beim L√∂schen');
                setSyncStatus('error');
            }
        }
        
        // Tasks rendern
        function renderTasks() {
            const today = getToday();
            const hideCompleted = document.getElementById('hideCompleted').checked;
            const filterPriority = document.getElementById('filterTaskPriority').value.toLowerCase();
            const filterStatus = document.getElementById('filterTaskStatus').value.toLowerCase();
            
            // Tasks filtern
            let filteredTasks = tasks.filter(task => {
                if (hideCompleted && task.status.toLowerCase() === 'erledigt') return false;
                if (filterPriority && (task.prioritaet || '').toLowerCase() !== filterPriority) return false;
                if (filterStatus && (task.status || '').toLowerCase() !== filterStatus) return false;
                return true;
            });
            
            // Kategorisieren
            const overdue = filteredTasks.filter(t => 
                t.faelligAm && t.faelligAm < today && t.status.toLowerCase() !== 'erledigt'
            );
            const todayTasks = filteredTasks.filter(t => 
                t.faelligAm === today && t.status.toLowerCase() !== 'erledigt'
            );
            const upcoming = filteredTasks.filter(t => 
                (!t.faelligAm || t.faelligAm > today) && t.status.toLowerCase() !== 'erledigt'
            );
            const completed = filteredTasks.filter(t => 
                t.status.toLowerCase() === 'erledigt'
            );
            
            // √úberf√§llige rendern
            const overdueSection = document.getElementById('overdueTasks');
            const overdueList = document.getElementById('overdueTasksList');
            if (overdue.length > 0) {
                overdueSection.classList.remove('hidden');
                document.getElementById('overdueCount').textContent = overdue.length;
                overdueList.innerHTML = overdue.map(t => renderTaskItem(t, 'overdue')).join('');
            } else {
                overdueSection.classList.add('hidden');
            }
            
            // Heute f√§llige rendern
            const todaySection = document.getElementById('todayTasks');
            const todayList = document.getElementById('todayTasksList');
            if (todayTasks.length > 0) {
                todaySection.classList.remove('hidden');
                document.getElementById('todayTasksCount').textContent = todayTasks.length;
                todayList.innerHTML = todayTasks.map(t => renderTaskItem(t, 'today')).join('');
            } else {
                todaySection.classList.add('hidden');
            }
            
            // Kommende rendern
            const upcomingList = document.getElementById('upcomingTasksList');
            const noTasksMsg = document.getElementById('noTasksMessage');
            document.getElementById('upcomingCount').textContent = upcoming.length;
            if (upcoming.length > 0) {
                noTasksMsg.classList.add('hidden');
                upcomingList.innerHTML = upcoming.map(t => renderTaskItem(t, 'upcoming')).join('');
            } else {
                upcomingList.innerHTML = '';
                if (overdue.length === 0 && todayTasks.length === 0 && completed.length === 0) {
                    noTasksMsg.classList.remove('hidden');
                } else {
                    noTasksMsg.classList.add('hidden');
                }
            }
            
            // Erledigte rendern
            const completedSection = document.getElementById('completedTasksSection');
            const completedList = document.getElementById('completedTasksList');
            if (completed.length > 0 && !hideCompleted) {
                completedSection.classList.remove('hidden');
                document.getElementById('completedCount').textContent = completed.length;
                completedList.innerHTML = completed.map(t => renderTaskItem(t, 'completed')).join('');
            } else {
                completedSection.classList.add('hidden');
            }
        }
        
        function renderTaskItem(task, category) {
            const isCompleted = task.status.toLowerCase() === 'erledigt';
            const priorityIcon = getPriorityIcon(task.prioritaet);
            const statusBadge = getStatusBadge(task.status);
            
            const bgClass = {
                'overdue': 'bg-red-900/20',
                'today': 'bg-orange-900/20',
                'upcoming': 'bg-br-800/50',
                'completed': 'bg-br-800/30'
            }[category];
            
            return `
                <div class="p-3 ${bgClass} flex items-start gap-3">
                    <button onclick="toggleTaskStatus('${task.id}')" 
                            class="mt-0.5 w-6 h-6 rounded border-2 flex items-center justify-center flex-shrink-0 transition-colors active:scale-95
                                   ${isCompleted ? 'bg-green-600 border-green-600 text-white' : 'border-gray-500 hover:border-blue-500 active:border-blue-400'}">
                        ${isCompleted ? '‚úì' : ''}
                    </button>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="${isCompleted ? 'line-through text-br-300' : 'text-white'} text-sm font-medium">
                                ${escapeHtml(task.aufgabe)}
                            </span>
                            <span class="text-xs">${priorityIcon}</span>
                            ${statusBadge}
                        </div>
                        <div class="flex items-center gap-3 mt-1 text-xs text-br-200">
                            ${task.faelligAm ? `<span>üìÖ ${formatDate(task.faelligAm)}</span>` : ''}
                            ${task.notizen ? `<span class="truncate max-w-32" title="${escapeHtml(task.notizen)}">üìù ${escapeHtml(task.notizen.substring(0, 30))}${task.notizen.length > 30 ? '...' : ''}</span>` : ''}
                        </div>
                    </div>
                    <button onclick="editTask('${task.id}')" 
                            class="px-3 py-1 bg-br-700 hover:bg-br-600 active:bg-gray-500 rounded-lg text-xs font-medium transition-colors">
                        ‚úèÔ∏è
                    </button>
                </div>
            `;
        }
        
        function getPriorityIcon(priority) {
            const p = (priority || 'mittel').toLowerCase();
            if (p === 'hoch') return 'üî¥';
            if (p === 'niedrig') return 'üü¢';
            return 'üü°';
        }
        
        function getStatusBadge(status) {
            const s = (status || 'offen').toLowerCase();
            if (s === 'erledigt') return '<span class="text-xs bg-green-600/30 text-green-400 px-2 py-0.5 rounded">Erledigt</span>';
            if (s === 'in bearbeitung') return '<span class="text-xs bg-br-500/30 text-blue-400 px-2 py-0.5 rounded">In Bearbeitung</span>';
            return '<span class="text-xs bg-gray-600/30 text-br-200 px-2 py-0.5 rounded">Offen</span>';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Startbildschirm beim App-Start
        function showTasksDashboardOnStart() {
            tasksDashboardShown = true;
            
            const today = getToday();
            const overdue = tasks.filter(t => 
                t.faelligAm && t.faelligAm < today && t.status.toLowerCase() !== 'erledigt'
            );
            const todayTasks = tasks.filter(t => 
                t.faelligAm === today && t.status.toLowerCase() !== 'erledigt'
            );
            
            // Nur zeigen wenn es dringende Aufgaben gibt
            if (overdue.length === 0 && todayTasks.length === 0) {
                return;
            }
            
            // Dashboard-Content f√ºllen
            const dashOverdue = document.getElementById('dashOverdue');
            const dashToday = document.getElementById('dashToday');
            const dashNoUrgent = document.getElementById('dashNoUrgent');
            
            if (overdue.length > 0) {
                dashOverdue.classList.remove('hidden');
                document.getElementById('dashOverdueList').innerHTML = overdue.map(t => renderDashboardTaskItem(t)).join('');
            } else {
                dashOverdue.classList.add('hidden');
            }
            
            if (todayTasks.length > 0) {
                dashToday.classList.remove('hidden');
                document.getElementById('dashTodayList').innerHTML = todayTasks.map(t => renderDashboardTaskItem(t)).join('');
            } else {
                dashToday.classList.add('hidden');
            }
            
            if (overdue.length === 0 && todayTasks.length === 0) {
                dashNoUrgent.classList.remove('hidden');
            } else {
                dashNoUrgent.classList.add('hidden');
            }
            
            // Modal zeigen
            document.getElementById('tasksDashboardModal').classList.remove('hidden');
            document.getElementById('tasksDashboardModal').classList.add('flex');
        }
        
        function renderDashboardTaskItem(task) {
            const priorityIcon = getPriorityIcon(task.prioritaet);
            return `
                <div class="flex items-center gap-2 p-2 bg-br-800/50 rounded-lg">
                    <span>${priorityIcon}</span>
                    <span class="text-sm flex-1">${escapeHtml(task.aufgabe)}</span>
                    ${task.faelligAm ? `<span class="text-xs text-br-200">${formatDate(task.faelligAm)}</span>` : ''}
                </div>
            `;
        }
        
        function closeTasksDashboard() {
            document.getElementById('tasksDashboardModal').classList.add('hidden');
            document.getElementById('tasksDashboardModal').classList.remove('flex');
        }

        // ==================== HELPERS ====================
        function getToday() {
            return new Date().toISOString().split('T')[0];
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            return `${d}.${m}.${y}`;
        }

        function showToast(message, duration = 3000) {
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification fixed bottom-24 left-4 right-4 bg-br-500 text-white px-4 py-3 rounded-xl shadow-lg z-50 text-center text-sm font-medium';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ==================== APP LIFECYCLE ====================
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // App geht in Hintergrund - Timer-Zustand speichern
                if (isRunning) {
                    saveTimerState();
                    console.log('üì± App in Hintergrund - Timer gespeichert');
                }
            } else {
                // App kommt zur√ºck - Timer aktualisieren
                if (isRunning && timerStart) {
                    recalculateTimer();
                    console.log('üì± App wieder aktiv - Timer aktualisiert');
                }
            }
        });
        
        function recalculateTimer() {
            if (!timerStart || !isRunning) return;
            
            const now = new Date();
            const elapsedSeconds = Math.floor((now - timerStart) / 1000);
            
            const useCountdown = document.getElementById('useCountdown').checked;
            
            if (useCountdown) {
                const countdownMinutes = parseInt(document.getElementById('countdownMinutes').value) || 60;
                const totalSeconds = countdownMinutes * 60;
                timerSeconds = Math.max(0, totalSeconds - elapsedSeconds);
                
                // Countdown abgelaufen w√§hrend App im Hintergrund war?
                if (timerSeconds <= 0) {
                    timerSeconds = 0;
                    stopTimer();
                    // AudioContext reaktivieren versuchen
                    if (audioCtx && audioCtx.state === 'suspended') {
                        audioCtx.resume();
                    }
                    notifyTimerEnd();
                    return;
                }
            } else {
                timerSeconds = elapsedSeconds;
            }
            
            updateTimerDisplay();
        }

        window.addEventListener('beforeunload', () => {
            if (isRunning) saveTimerState();
        });

        window.addEventListener('pagehide', () => {
            if (isRunning) saveTimerState();
        });
        
        // iOS Safari: pageshow Event f√ºr zur√ºckkehren aus Hintergrund
        window.addEventListener('pageshow', (event) => {
            if (event.persisted && isRunning && timerStart) {
                recalculateTimer();
                console.log('üì± pageshow - Timer aktualisiert');
            }
        });
        
        // Fokus-Event als zus√§tzlicher Fallback
        window.addEventListener('focus', () => {
            if (isRunning && timerStart) {
                recalculateTimer();
            }
        });

        setInterval(() => {
            if (isRunning) saveTimerState();
        }, 30000);

        // PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }

        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>

    <!-- Task Edit Modal - am Ende des body f√ºr korrektes z-index Verhalten -->
    <div id="editTaskModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; align-items: center; justify-content: center; background: rgba(0,0,0,0.8);">
        <div style="background: #1f2937; border-radius: 16px; padding: 24px; margin: 16px; max-width: 400px; width: 100%; border: 1px solid #374151; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
            <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: white;">‚úèÔ∏è Aufgabe bearbeiten</h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div>
                    <label style="font-size: 12px; color: #9ca3af; display: block; margin-bottom: 4px;">Aufgabe</label>
                    <input type="text" id="editTaskTitle" style="width: 100%; background: #374151; border: 1px solid #4b5563; border-radius: 8px; padding: 12px; font-size: 14px; color: white; box-sizing: border-box;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label style="font-size: 12px; color: #9ca3af; display: block; margin-bottom: 4px;">F√§llig am</label>
                        <input type="date" id="editTaskDue" style="width: 100%; background: #374151; border: 1px solid #4b5563; border-radius: 8px; padding: 12px; font-size: 14px; color: white; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #9ca3af; display: block; margin-bottom: 4px;">Priorit√§t</label>
                        <select id="editTaskPriority" style="width: 100%; background: #374151; border: 1px solid #4b5563; border-radius: 8px; padding: 12px; font-size: 14px; color: white; box-sizing: border-box;">
                            <option value="hoch">üî¥ Hoch</option>
                            <option value="mittel">üü° Mittel</option>
                            <option value="niedrig">üü¢ Niedrig</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label style="font-size: 12px; color: #9ca3af; display: block; margin-bottom: 4px;">Status</label>
                    <select id="editTaskStatus" style="width: 100%; background: #374151; border: 1px solid #4b5563; border-radius: 8px; padding: 12px; font-size: 14px; color: white; box-sizing: border-box;">
                        <option value="offen">Offen</option>
                        <option value="in bearbeitung">In Bearbeitung</option>
                        <option value="erledigt">Erledigt</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 12px; color: #9ca3af; display: block; margin-bottom: 4px;">Notizen</label>
                    <textarea id="editTaskNotes" style="width: 100%; background: #374151; border: 1px solid #4b5563; border-radius: 8px; padding: 12px; font-size: 14px; color: white; height: 80px; resize: none; box-sizing: border-box;"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button onclick="closeEditTaskModal()" style="flex: 1; padding: 12px; background: #374151; border: none; border-radius: 8px; font-size: 14px; color: white; cursor: pointer;">Abbrechen</button>
                <button onclick="deleteTask()" style="padding: 12px 16px; background: #dc2626; border: none; border-radius: 8px; font-size: 14px; color: white; cursor: pointer;">üóëÔ∏è</button>
                <button onclick="saveTaskEdit()" style="flex: 1; padding: 12px; background: #2563eb; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; color: white; cursor: pointer;">üíæ Speichern</button>
            </div>
        </div>
    </div>
</body>
</html>
